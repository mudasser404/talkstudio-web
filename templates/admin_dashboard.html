{% extends 'dashboard_base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Admin Dashboard" %}{% endblock %}

{% block extra_css %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<style>
    .admin-header {
        background: linear-gradient(135deg, #000000 0%, #1A1A1A 100%);
        color: white;
        padding: 40px 0;
        margin-bottom: 32px;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 32px;
    }

    @media (max-width: 992px) {
        .stat-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 576px) {
        .stat-grid {
            grid-template-columns: 1fr;
        }
    }

    .stat-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-lg);
    }

    .stat-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .stat-label {
        font-size: 14px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-icon {
        width: 48px;
        height: 48px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        margin-bottom: 16px;
    }

    .action-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        margin-bottom: 24px;
    }

    .admin-tabs {
        display: flex;
        gap: 8px;
        border-bottom: 1px solid var(--border-color);
        margin-bottom: 24px;
    }

    .admin-tab {
        padding: 12px 24px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s ease;
    }

    .admin-tab:hover {
        color: var(--text-primary);
    }

    .admin-tab.active {
        color: var(--primary);
        border-bottom-color: var(--primary);
    }

    .tab-panel {
        display: none;
    }

    .tab-panel.active {
        display: block;
    }

    .user-table {
        width: 100%;
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        overflow: hidden;
    }

    .user-table th {
        background: var(--bg-tertiary);
        padding: 12px 16px;
        font-size: 13px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-secondary);
    }

    .user-table td {
        padding: 16px;
        border-top: 1px solid var(--border-color);
    }

    .user-table tr:hover {
        background: var(--bg-hover);
    }

    .badge-status {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    .badge-status.active {
        background: #D1FAE5;
        color: #065F46;
    }

    .badge-status.inactive {
        background: #FEE2E2;
        color: #991B1B;
    }

    .badge-status.pending {
        background: #FEF3C7;
        color: #92400E;
    }

    .chart-container {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-lg);
        padding: 24px;
        height: 300px;
    }

    .quick-action-btn {
        width: 100%;
        padding: 16px;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .quick-action-btn:hover {
        border-color: var(--primary);
        background: var(--bg-hover);
    }

    .activity-feed {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 16px;
        border-left: 3px solid var(--border-color);
        margin-bottom: 16px;
        background: var(--bg-tertiary);
        border-radius: 0 var(--radius-md) var(--radius-md) 0;
    }

    .activity-item:hover {
        border-left-color: var(--primary);
    }

    .activity-time {
        font-size: 12px;
        color: var(--text-tertiary);
    }
/* Responsive Styles */    @media (max-width: 1200px) {        .stat-value {            font-size: 28px;        }    }    @media (max-width: 992px) {        .admin-header {            padding: 24px 0;        }        .admin-header h1 {            font-size: 24px;        }        .admin-header .d-flex {            flex-direction: column;            align-items: flex-start !important;            gap: 16px;        }        .admin-header .d-flex > div:last-child {            width: 100%;            justify-content: flex-start;        }        .chart-container {            height: 250px;        }        .col-lg-8, .col-lg-4 {            margin-bottom: 24px;        }    }    @media (max-width: 768px) {        .admin-tabs {            overflow-x: auto;            white-space: nowrap;            -webkit-overflow-scrolling: touch;        }        .admin-tab {            padding: 10px 16px;            font-size: 14px;        }        .action-card {            padding: 16px;        }        .stat-card {            padding: 16px;        }        .stat-value {            font-size: 24px;        }        .stat-icon {            width: 40px;            height: 40px;            font-size: 16px;        }        .user-table {            display: block;            overflow-x: auto;            white-space: nowrap;            -webkit-overflow-scrolling: touch;        }        .user-table th,        .user-table td {            padding: 12px;            font-size: 13px;        }        .row.mb-3 > div {            margin-bottom: 12px;        }        .quick-action-btn {            padding: 12px;        }        .quick-action-btn i.fa-2x {            font-size: 1.5em;        }        .activity-feed {            max-height: 300px;        }        .activity-item {            padding: 12px;        }    }    @media (max-width: 576px) {        .admin-header {            padding: 16px 0;        }        .admin-header h1 {            font-size: 20px;        }        .admin-header p {            font-size: 14px;        }        .container {            padding-left: 12px;            padding-right: 12px;        }        .stat-grid {            gap: 12px;        }        .stat-card {            padding: 12px;        }        .stat-value {            font-size: 20px;        }        .stat-label {            font-size: 12px;        }        .stat-icon {            width: 36px;            height: 36px;            font-size: 14px;            margin-bottom: 12px;        }        .action-card {            padding: 12px;            margin-bottom: 16px;        }        h5 {            font-size: 16px;        }        .chart-container {            height: 200px;            padding: 12px;        }        .quick-action-btn {            padding: 10px;            gap: 12px;        }        .quick-action-btn i.fa-2x {            font-size: 1.2em;        }        .quick-action-btn strong {            font-size: 14px;        }        .quick-action-btn .text-muted {            font-size: 11px !important;        }        .btn {            padding: 8px 12px;            font-size: 13px;        }        .btn-outline-light {            padding: 6px 10px;            font-size: 12px;        }        .form-control,        .form-select {            font-size: 14px;            padding: 8px 12px;        }        .badge {            font-size: 10px;            padding: 4px 8px;        }        .badge-status {            font-size: 10px;            padding: 3px 8px;        }        .modal-dialog {            margin: 8px;        }        .modal-content {            border-radius: 12px;        }        .modal-header,        .modal-body,        .modal-footer {            padding: 12px 16px;        }    }    .table-responsive-wrapper {        overflow-x: auto;        -webkit-overflow-scrolling: touch;        margin: 0 -12px;        padding: 0 12px;    }
</style>
{% endblock %}

{% block content %}
<!-- Admin Header -->
<section class="admin-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">{% trans "Admin Dashboard" %}</h1>
                <p class="mb-0 opacity-75">{% blocktrans with username=user.username %}Welcome back, {{ username }}!{% endblocktrans %}</p>
            </div>
            <div class="d-flex gap-3 align-items-center">
                <a href="/activity-logs/" class="btn btn-outline-light">
                    <i class="fas fa-history me-2"></i>{% trans "Activity Logs" %}
                </a>
                <span class="badge bg-white text-dark">{% trans "Super Admin" %}</span>
            </div>
        </div>
    </div>
</section>

<div class="container pb-5">
    <!-- Stats Grid -->
    <div class="stat-grid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #DBEAFE; color: #1E40AF;">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-value" id="total-users">0</div>
            <div class="stat-label">
                <span>{% trans "Total Users" %}</span>
                <i class="fas fa-arrow-up text-success" style="font-size: 12px;"></i>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #D1FAE5; color: #065F46;">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-value">$<span id="total-revenue">0</span></div>
            <div class="stat-label">
                <span>{% trans "Total Revenue" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #E9D5FF; color: #6B21A8;">
                <i class="fas fa-magic"></i>
            </div>
            <div class="stat-value" id="total-generations">0</div>
            <div class="stat-label">
                <span>{% trans "Generations" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #FEE2E2; color: #991B1B;">
                <i class="fas fa-user-plus"></i>
            </div>
            <div class="stat-value" id="users-registered-today">0</div>
            <div class="stat-label">
                <span>{% trans "Registered Today" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #D1FAE5; color: #065F46;">
                <i class="fas fa-circle" style="color: #10B981;"></i>
            </div>
            <div class="stat-value" id="online-users">0</div>
            <div class="stat-label">
                <span>{% trans "Online Now" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #FEF3C7; color: #92400E;">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-value" id="audio-pending">0</div>
            <div class="stat-label">
                <span>{% trans "In Queue" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #DBEAFE; color: #1E40AF;">
                <i class="fas fa-cog fa-spin"></i>
            </div>
            <div class="stat-value" id="audio-processing">0</div>
            <div class="stat-label">
                <span>{% trans "Processing" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #D1FAE5; color: #065F46;">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-value" id="audio-completed">0</div>
            <div class="stat-label">
                <span>{% trans "Completed" %}</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon" style="background: #FEE2E2; color: #991B1B;">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-value" id="audio-failed">0</div>
            <div class="stat-label">
                <span>{% trans "Failed" %}</span>
            </div>
        </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="action-card">
        <!-- Hidden tabs - navigation moved to sidebar -->
        <div class="admin-tabs" style="display: none;">
            <button class="admin-tab active" data-tab="overview"></button>
            <button class="admin-tab" data-tab="users"></button>
            <button class="admin-tab" data-tab="payments"></button>
            <button class="admin-tab" data-tab="announcements"></button>
            <button class="admin-tab" data-tab="email-marketing"></button>
            <button class="admin-tab" data-tab="packages"></button>
        </div>

        <!-- Overview Tab -->
        <div class="tab-panel active" id="overview-tab">
            <div class="row">
                <div class="col-lg-8">
                    <h5 class="mb-3">{% trans "Revenue Overview" %}</h5>
                    <div class="chart-container">
                        <canvas id="revenue-chart"></canvas>
                    </div>

                    <h5 class="mb-3 mt-4">{% trans "Recent Activity" %}</h5>
                    <div class="activity-feed">
                        <div class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">{% trans "Loading..." %}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <h5 class="mb-3">{% trans "Quick Actions" %}</h5>
                    <button class="quick-action-btn" onclick="openCreateUserModal()">
                        <i class="fas fa-user-plus fa-2x text-primary"></i>
                        <div>
                            <strong>{% trans "Add New User" %}</strong>
                            <div class="text-muted" style="font-size: 13px;">{% trans "Create a new user account" %}</div>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="openAnnouncementModal()">
                        <i class="fas fa-bullhorn fa-2x text-success"></i>
                        <div>
                            <strong>{% trans "Create Announcement" %}</strong>
                            <div class="text-muted" style="font-size: 13px;">{% trans "Post message to all users" %}</div>
                        </div>
                    </button>
                    <button class="quick-action-btn" onclick="window.location.href='{% url 'activity-logs' %}'">
                        <i class="fas fa-history fa-2x text-info"></i>
                        <div>
                            <strong>{% trans "Activity Logs" %}</strong>
                            <div class="text-muted" style="font-size: 13px;">{% trans "View system activity" %}</div>
                        </div>
                    </button>
                    <a href="{% url 'platform-settings' %}" class="quick-action-btn" style="text-decoration: none; color: inherit;">
                        <i class="fas fa-cog fa-2x text-warning"></i>
                        <div>
                            <strong>{% trans "Platform Settings" %}</strong>
                            <div class="text-muted" style="font-size: 13px;">{% trans "Configure platform" %}</div>
                        </div>
                    </a>
                    <button class="quick-action-btn" onclick="window.location.href='{% url 'language-management' %}'">
                        <i class="fas fa-language fa-2x text-danger"></i>
                        <div>
                            <strong>{% trans "Language Management" %}</strong>
                            <div class="text-muted" style="font-size: 13px;">{% trans "Enable/disable languages" %}</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Voice Cloning Status Tracking Section -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="action-card">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="fas fa-microphone-alt me-2"></i>{% trans "Voice Cloning Status Monitor" %}</h5>
                            <div>
                                <button class="btn btn-sm btn-primary me-2" onclick="loadVoiceCloningStatus()">
                                    <i class="fas fa-sync-alt me-1"></i>{% trans "Refresh" %}
                                </button>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-danger dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-trash me-1"></i>{% trans "Bulk Delete" %}
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="confirmBulkDelete('pending')"><i class="fas fa-clock me-2 text-warning"></i>{% trans "Delete All Pending" %}</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="confirmBulkDelete('failed')"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>{% trans "Delete All Failed" %}</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="confirmBulkDelete('completed')"><i class="fas fa-check-circle me-2 text-success"></i>{% trans "Delete All Completed" %}</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="confirmBulkDelete('all')"><i class="fas fa-trash-alt me-2"></i>{% trans "Delete All Records" %}</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Status Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="stat-card" style="border-left: 4px solid #FFA500;">
                                    <div class="stat-value" id="vc-status-pending">0</div>
                                    <div class="stat-label">
                                        <i class="fas fa-clock text-warning me-2"></i>
                                        <span>{% trans "In Queue" %}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" style="border-left: 4px solid #2196F3;">
                                    <div class="stat-value" id="vc-status-processing">0</div>
                                    <div class="stat-label">
                                        <i class="fas fa-cog fa-spin text-primary me-2"></i>
                                        <span>{% trans "Processing" %}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" style="border-left: 4px solid #4CAF50;">
                                    <div class="stat-value" id="vc-status-completed">0</div>
                                    <div class="stat-label">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <span>{% trans "Completed" %}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="stat-card" style="border-left: 4px solid #F44336;">
                                    <div class="stat-value" id="vc-status-failed">0</div>
                                    <div class="stat-label">
                                        <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                        <span>{% trans "Failed" %}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Tabs -->
                        <ul class="nav nav-tabs mb-3" id="vcStatusTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="vc-queue-tab" data-bs-toggle="tab" data-bs-target="#vc-queue" type="button" role="tab">
                                    <i class="fas fa-clock me-1"></i>{% trans "Queue" %} <span class="badge bg-warning" id="vc-queue-badge">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vc-processing-tab" data-bs-toggle="tab" data-bs-target="#vc-processing" type="button" role="tab">
                                    <i class="fas fa-cog me-1"></i>{% trans "Processing" %} <span class="badge bg-primary" id="vc-processing-badge">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vc-completed-tab" data-bs-toggle="tab" data-bs-target="#vc-completed" type="button" role="tab">
                                    <i class="fas fa-check me-1"></i>{% trans "Completed" %} <span class="badge bg-success" id="vc-completed-badge">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vc-failed-tab" data-bs-toggle="tab" data-bs-target="#vc-failed" type="button" role="tab">
                                    <i class="fas fa-times me-1"></i>{% trans "Failed" %} <span class="badge bg-danger" id="vc-failed-badge">0</span>
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="vc-users-tab" data-bs-toggle="tab" data-bs-target="#vc-users" type="button" role="tab">
                                    <i class="fas fa-users me-1"></i>{% trans "User Stats" %}
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="vcStatusTabContent">
                            <!-- Queue Tab -->
                            <div class="tab-pane fade show active" id="vc-queue" role="tabpanel">
                                <div class="table-responsive">
                                    <table id="vc-queue-table" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>{% trans "User" %}</th>
                                                <th>{% trans "Text Preview" %}</th>
                                                <th>{% trans "Characters" %}</th>
                                                <th>{% trans "Credits" %}</th>
                                                <th>{% trans "Created At" %}</th>
                                                <th>{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vc-queue-tbody">
                                            <tr><td colspan="6" class="text-center py-4">{% trans "Loading..." %}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Processing Tab -->
                            <div class="tab-pane fade" id="vc-processing" role="tabpanel">
                                <div class="table-responsive">
                                    <table id="vc-processing-table" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>{% trans "User" %}</th>
                                                <th>{% trans "Text Preview" %}</th>
                                                <th>{% trans "Progress" %}</th>
                                                <th>{% trans "Started At" %}</th>
                                                <th>{% trans "Est. Time" %}</th>
                                                <th>{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vc-processing-tbody">
                                            <tr><td colspan="6" class="text-center py-4">{% trans "Loading..." %}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Completed Tab -->
                            <div class="tab-pane fade" id="vc-completed" role="tabpanel">
                                <div class="table-responsive">
                                    <table id="vc-completed-table" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>{% trans "User" %}</th>
                                                <th>{% trans "Text Preview" %}</th>
                                                <th>{% trans "Duration" %}</th>
                                                <th>{% trans "File Size" %}</th>
                                                <th>{% trans "Completed At" %}</th>
                                                <th>{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vc-completed-tbody">
                                            <tr><td colspan="6" class="text-center py-4">{% trans "Loading..." %}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Failed Tab -->
                            <div class="tab-pane fade" id="vc-failed" role="tabpanel">
                                <div class="table-responsive">
                                    <table id="vc-failed-table" class="table table-striped table-hover dt-responsive nowrap" style="width:100%">
                                        <thead>
                                            <tr>
                                                <th>{% trans "User" %}</th>
                                                <th>{% trans "Text Preview" %}</th>
                                                <th>{% trans "Error" %}</th>
                                                <th>{% trans "Created At" %}</th>
                                                <th>{% trans "Actions" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vc-failed-tbody">
                                            <tr><td colspan="5" class="text-center py-4">{% trans "Loading..." %}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- User Stats Tab -->
                            <div class="tab-pane fade" id="vc-users" role="tabpanel">
                                <div class="table-responsive">
                                    <table class="user-table">
                                        <thead>
                                            <tr>
                                                <th>{% trans "User" %}</th>
                                                <th>{% trans "Email" %}</th>
                                                <th>{% trans "Pending" %}</th>
                                                <th>{% trans "Processing" %}</th>
                                                <th>{% trans "Completed" %}</th>
                                                <th>{% trans "Failed" %}</th>
                                                <th>{% trans "Total" %}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="vc-users-tbody">
                                            <tr><td colspan="7" class="text-center py-4">{% trans "Loading..." %}</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-panel" id="users-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{% trans "User Management" %}</h5>
                <button class="btn btn-primary" onclick="openCreateUserModal()">
                    <i class="fas fa-user-plus me-2"></i>{% trans "Add User" %}
                </button>
            </div>

            <!-- Filters and Search -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <input type="text" class="form-control" id="users-search" placeholder="{% trans 'Search users...' %}" onkeyup="filterUsers()">
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="users-plan-filter" onchange="filterUsers()">
                        <option value="">{% trans "All Plans" %}</option>
                        <option value="free">{% trans "Free" %}</option>
                        <option value="basic">{% trans "Basic" %}</option>
                        <option value="pro">{% trans "Pro" %}</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" id="users-status-filter" onchange="filterUsers()">
                        <option value="">{% trans "All Status" %}</option>
                        <option value="active">{% trans "Active" %}</option>
                        <option value="inactive">{% trans "Inactive" %}</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" id="users-page-size" onchange="changeUsersPageSize()">
                        <option value="10">{% trans "10 per page" %}</option>
                        <option value="25">{% trans "25 per page" %}</option>
                        <option value="50">{% trans "50 per page" %}</option>
                        <option value="100">{% trans "100 per page" %}</option>
                    </select>
                </div>
            </div>

            <table class="user-table">
                <thead>
                    <tr>
                        <th style="cursor: pointer;" onclick="sortUsers('username')">{% trans "User" %} <i class="fas fa-sort" id="sort-username"></i></th>
                        <th style="cursor: pointer;" onclick="sortUsers('email')">{% trans "Email" %} <i class="fas fa-sort" id="sort-email"></i></th>
                        <th style="cursor: pointer;" onclick="sortUsers('plan')">{% trans "Plan" %} <i class="fas fa-sort" id="sort-plan"></i></th>
                        <th style="cursor: pointer;" onclick="sortUsers('credits')">{% trans "Credits" %} <i class="fas fa-sort" id="sort-credits"></i></th>
                        <th style="cursor: pointer;" onclick="sortUsers('status')">{% trans "Status" %} <i class="fas fa-sort" id="sort-status"></i></th>
                        <th style="cursor: pointer;" onclick="sortUsers('joined')">{% trans "Joined" %} <i class="fas fa-sort" id="sort-joined"></i></th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="users-table-body">
                    <tr>
                        <td colspan="7" class="text-center py-4">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">{% trans "Loading..." %}</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-3">
                <div id="users-showing-text">{% trans "Showing 0 of 0" %}</div>
                <nav>
                    <ul class="pagination mb-0" id="users-pagination"></ul>
                </nav>
            </div>
        </div>

        <!-- Payments Tab -->
        <div class="tab-panel" id="payments-tab">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">{% trans "Payment Transactions" %}</h5>
                <div>
                    <!-- Status Filter -->
                    <select class="form-select form-select-sm d-inline-block me-2" id="payments-status-filter" onchange="loadPayments(1)" style="width: auto;">
                        <option value="">{% trans "All Status" %}</option>
                        <option value="completed">{% trans "Completed" %}</option>
                        <option value="pending">{% trans "Pending" %}</option>
                        <option value="failed">{% trans "Failed" %}</option>
                        <option value="refunded">{% trans "Refunded" %}</option>
                    </select>
                    <button class="btn btn-danger me-2" id="delete-selected-payments-btn" onclick="deleteSelectedPayments()" style="display:none;">
                        <i class="fas fa-trash me-2"></i>{% trans "Delete Selected" %}
                    </button>
                    <button class="btn btn-primary" onclick="exportPayments()">
                        <i class="fas fa-download me-2"></i>{% trans "Export to CSV" %}
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="user-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-payments" onchange="toggleAllPayments(this)"></th>
                            <th>{% trans "Transaction ID" %}</th>
                            <th>{% trans "User" %}</th>
                            <th>{% trans "Amount" %}</th>
                            <th>{% trans "Method" %}</th>
                            <th>{% trans "Type" %}</th>
                            <th>{% trans "Status" %}</th>
                            <th>{% trans "Error/Reason" %}</th>
                            <th>{% trans "Date" %}</th>
                            <th>{% trans "Actions" %}</th>
                        </tr>
                    </thead>
                    <tbody id="payments-table-body">
                        <tr>
                            <td colspan="10" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">{% trans "Loading..." %}</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination Controls -->
            <div class="d-flex justify-content-between align-items-center mt-3 flex-wrap gap-2">
                <div class="text-muted">
                    <span id="payments-showing-info">Showing 0 of 0 payments</span>
                </div>
                <nav aria-label="Payments pagination">
                    <ul class="pagination mb-0" id="payments-pagination">
                        <!-- Pagination buttons will be inserted here -->
                    </ul>
                </nav>
                <div>
                    <select class="form-select form-select-sm" id="payments-per-page" onchange="loadPayments(1)" style="width: auto;">
                        <option value="10">10 per page</option>
                        <option value="25" selected>25 per page</option>
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Talk Studio Tab -->
        <div class="tab-panel" id="voice-cloning-tab">
            <div class="container-fluid p-0">
                <h5 class="mb-4">AI Talk Studio Studio</h5>

                <div class="row g-4">
                    <!-- Voice Reference Upload -->
                    <div class="col-lg-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Voice Reference Audio</label>
                            <p class="text-muted small">Upload a voice sample (3-10 seconds recommended)</p>
                            <input type="file" class="form-control" id="voice-ref-audio" accept="audio/*">
                        </div>
                    </div>

                    <!-- Text Input -->
                    <div class="col-lg-8">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Text to Synthesize</label>
                            <textarea
                                class="form-control"
                                id="synthesis-text"
                                rows="6"
                                placeholder="Enter the text you want to synthesize here...&#10;&#10;Supports multiple languages including English, Chinese, etc.&#10;Maximum 50,000 characters"
                            ></textarea>
                            <small class="text-muted">Max: 50,000 characters</small>
                        </div>
                    </div>
                </div>

                <!-- Generate Button -->
                <div class="row">
                    <div class="col-12">
                        <button class="btn btn-primary btn-lg" id="generate-voice-btn">
                            <i class="fas fa-play me-2"></i>Generate Speech
                        </button>
                    </div>
                </div>

                <!-- Output Audio -->
                <div class="row mt-4" id="voice-output-section" style="display: none;">
                    <div class="col-12">
                        <label class="form-label fw-bold">Generated Result</label>
                        <audio id="output-audio" controls class="w-100" style="border-radius: 8px;"></audio>
                    </div>
                </div>

                <!-- Progress Indicator -->
                <div class="row mt-3" id="voice-progress-section" style="display: none;">
                    <div class="col-12">
                        <div class="d-flex align-items-center gap-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <span class="text-muted">Generating your voice... This may take a few moments.</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Announcements Tab -->
        <div class="tab-panel" id="announcements-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Manage Announcements</h5>
                <button class="btn btn-primary" onclick="openAnnouncementModal()">
                    <i class="fas fa-plus me-2"></i>Create Announcement
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Type</th>
                            <th>Priority</th>
                            <th>Status</th>
                            <th>Created By</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="announcements-table-body">
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Email Marketing Tab -->
        <div class="tab-panel" id="email-marketing-tab">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="mb-0">Email Marketing Campaigns</h5>
                <div>
                    <button class="btn btn-success me-2" onclick="openCSVUploadModal()">
                        <i class="fas fa-upload me-2"></i>Upload CSV List
                    </button>
                    <button class="btn btn-primary" onclick="openEmailMarketingModal()">
                        <i class="fas fa-paper-plane me-2"></i>Send Campaign Email
                    </button>
                </div>
            </div>

            <!-- CSV Email Lists Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-list me-2"></i>CSV Email Lists</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>List Name</th>
                                    <th>Total Emails</th>
                                    <th>Uploaded By</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="csv-lists-table-body">
                                <tr>
                                    <td colspan="5" class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Email Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="mb-1" id="total-users-count">0</h3>
                            <small class="text-muted">Total Users</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="mb-1" id="active-users-count">0</h3>
                            <small class="text-muted">Active Users</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="mb-1" id="emails-sent-count">0</h3>
                            <small class="text-muted">Emails Sent</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="mb-1" id="last-campaign-date">Never</h3>
                            <small class="text-muted">Last Campaign</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics Charts -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Campaign Performance (Last 7 Days)</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="campaignPerformanceChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Click-Through Rates</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="clickRateChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Recipient Source Distribution</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="recipientSourceChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Campaign History -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Campaign History</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Recipients</th>
                                    <th>Sent / Failed / Pending</th>
                                    <th>Sent By</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="email-campaigns-table-body">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {% include 'database_manager.html' %}

        <!-- Packages Tab -->
        <div class="tab-panel" id="packages-tab">
            <!-- Subscription Plans Section -->
            <div class="mb-5">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Subscription Plans</h5>
                    <button class="btn btn-primary" onclick="openCreatePlanModal()">
                        <i class="fas fa-plus me-2"></i>Create Plan
                    </button>
                </div>

                <div class="row g-4 mb-4" id="subscription-plans-grid">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Credit Packages Section -->
            <div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="mb-0">Credit Packages</h5>
                    <button class="btn btn-primary" onclick="openCreatePackageModal()">
                        <i class="fas fa-plus me-2"></i>Create Package
                    </button>
                </div>

                <div class="row g-4 mb-4" id="packages-grid">
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Manager Tab -->
        <div class="tab-panel" id="database-tab">
            <h5 class="mb-4">Database Manager</h5>
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Database management features will be added here.
            </div>
            <p class="text-muted">This tab is under development. Check back later for database management tools.</p>
        </div>
    </div>

    <!-- Create User Modal -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="create-user-form">
                        <div class="mb-3">
                            <label class="form-label">Email *</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username *</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password *</label>
                            <input type="password" class="form-control" name="password" required minlength="8">
                            <small class="text-muted">Minimum 8 characters</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Initial Credits</label>
                            <input type="number" class="form-control" name="credits" value="1000" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subscription Type</label>
                            <select class="form-select" name="subscription_type">
                                <option value="free">Free</option>
                                <option value="basic">Basic</option>
                                <option value="pro">Pro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active" checked>
                                <label class="form-check-label">Active</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_staff">
                                <label class="form-check-label">Staff</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createUser()">
                        <i class="fas fa-user-plus me-2"></i>Create User
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-user-form">
                        <input type="hidden" name="user_id">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="username" required>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">First Name</label>
                                <input type="text" class="form-control" name="first_name">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Last Name</label>
                                <input type="text" class="form-control" name="last_name">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Credits</label>
                            <input type="number" class="form-control" name="credits" min="0">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Subscription Type</label>
                            <select class="form-select" name="subscription_type">
                                <option value="free">Free</option>
                                <option value="basic">Basic</option>
                                <option value="pro">Pro</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="is_active">
                                <label class="form-check-label">Active</label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Credits Modal -->
    <div class="modal fade" id="addCreditsModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Credits</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="credits-user-id">
                    <div class="mb-3">
                        <label class="form-label">Amount</label>
                        <input type="number" class="form-control" id="credits-amount" min="1" value="1000">
                    </div>
                    <p class="text-muted small">Enter the number of credits to add to this user's account.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCredits()">
                        <i class="fas fa-plus me-2"></i>Add Credits
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Platform Settings Modal -->
    <div class="modal fade" id="platformSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Platform Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="platform-settings-form">
                        <h6 class="mb-3">Credit Calculation</h6>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Calculation Type</label>
                                <select class="form-select" id="credit_calculation_type">
                                    <option value="character">Per Character</option>
                                    <option value="word">Per Word</option>
                                    <option value="second">Per Second</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Credits Per Unit</label>
                                <input type="number" class="form-control" id="credits_per_unit" min="1" step="0.1">
                            </div>
                        </div>

                        <h6 class="mb-3 mt-4">Payment Gateways</h6>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="stripe_enabled">
                            <label class="form-check-label" for="stripe_enabled">Stripe</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="paypal_enabled">
                            <label class="form-check-label" for="paypal_enabled">PayPal</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="jazzcash_enabled">
                            <label class="form-check-label" for="jazzcash_enabled">JazzCash</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="easypaisa_enabled">
                            <label class="form-check-label" for="easypaisa_enabled">Easypaisa</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePlatformSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Announcement Modal -->
    <div class="modal fade" id="announcementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-bullhorn me-2"></i>Create Announcement
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="announcement-form">
                        <div class="mb-3">
                            <label class="form-label">Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="announcement_title" placeholder="Enter announcement title" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="announcement_message" rows="5" placeholder="Enter announcement message" required></textarea>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="announcement_type">
                                    <option value="info">Info</option>
                                    <option value="success">Success</option>
                                    <option value="warning">Warning</option>
                                    <option value="danger">Important</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Priority</label>
                                <select class="form-select" id="announcement_priority">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="announcement_active" checked>
                            <label class="form-check-label" for="announcement_active">
                                Active (Show to users immediately)
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="createAnnouncement()">
                        <i class="fas fa-paper-plane me-2"></i>Publish Announcement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSV Upload Modal -->
    <div class="modal fade" id="csvUploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-upload me-2"></i>Upload CSV Email List
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- CSV Format Guide -->
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="fas fa-info-circle me-2"></i>CSV Format Guide</h6>
                        <p class="mb-2">Your CSV file should have these columns (case insensitive):</p>
                        <ul class="mb-2">
                            <li><strong>email</strong> - Email address (required)</li>
                            <li><strong>username</strong> or <strong>name</strong> - Person's name (optional, defaults to email prefix)</li>
                        </ul>
                        <p class="mb-0"><strong>Example CSV:</strong></p>
                        <pre class="bg-white p-2 rounded border mb-0"><code>email,username
john@example.com,John Doe
jane@example.com,Jane Smith
ali@gmail.com,Ali Khan</code></pre>
                    </div>

                    <form id="csv-upload-form">
                        <div class="mb-3">
                            <label class="form-label">List Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="csv_list_name" placeholder="e.g., Newsletter Subscribers 2025" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="csv_list_description" rows="2" placeholder="Optional description for this email list"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">CSV File <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="csv_file" accept=".csv" required>
                            <small class="text-muted">Upload a CSV file with email addresses</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="uploadCSVList()">
                        <i class="fas fa-upload me-2"></i>Upload List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Marketing Modal -->
    <div class="modal fade" id="emailMarketingModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-envelope me-2"></i>Send Marketing Email
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="email-marketing-form">
                        <!-- Recipient Source Selection -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label class="form-label">Recipient Source <span class="text-danger">*</span></label>
                                <select class="form-select" id="recipient_source" required onchange="toggleRecipientOptions()">
                                    <option value="website">Website Users Only</option>
                                    <option value="csv">CSV List Only</option>
                                    <option value="both">Both Website & CSV Users</option>
                                </select>
                            </div>
                        </div>

                        <!-- Website Users Selection (shown when source is 'website' or 'both') -->
                        <div class="row mb-3" id="website-users-section">
                            <div class="col-md-6">
                                <label class="form-label">Website Users <span class="text-danger">*</span></label>
                                <select class="form-select" id="email_recipients" required>
                                    <option value="all">All Users</option>
                                    <option value="active">Active Users Only</option>
                                    <option value="inactive">Inactive Users</option>
                                    <option value="free">Free Plan Users</option>
                                    <option value="basic">Basic Plan Users</option>
                                    <option value="pro">Pro Plan Users</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Email Template</label>
                                <select class="form-select" id="email_template" onchange="loadEmailTemplate()">
                                    <option value="custom">Custom (Write your own)</option>
                                    <option value="deal">Special Deal</option>
                                    <option value="feature">New Feature</option>
                                    <option value="update">System Update</option>
                                    <option value="promotion">Promotion</option>
                                </select>
                            </div>
                        </div>

                        <!-- CSV List Selection (shown when source is 'csv' or 'both') -->
                        <div class="row mb-3" id="csv-list-section" style="display: none;">
                            <div class="col-md-12">
                                <label class="form-label">Select CSV List <span class="text-danger">*</span></label>
                                <select class="form-select" id="csv_list_id" required>
                                    <option value="">-- Select a CSV List --</option>
                                    <!-- Populated by JavaScript -->
                                </select>
                                <small class="text-muted">Upload a CSV list first if no lists are available.</small>
                            </div>
                        </div>

                        <!-- Email Subject -->
                        <div class="mb-3">
                            <label class="form-label">Subject <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="email_subject" placeholder="Enter email subject" required>
                        </div>

                        <!-- Email Body -->
                        <div class="mb-3">
                            <label class="form-label">Message <span class="text-danger">*</span></label>
                            <textarea class="form-control" id="email_body" rows="10" placeholder="Enter email message (HTML supported)" required></textarea>
                            <div class="alert alert-info mt-2 mb-0">
                                <strong><i class="fas fa-magic me-2"></i>Dynamic Variables (will be replaced automatically):</strong><br>
                                <small>
                                    <strong>User Data:</strong> {{username}}, {{user_name}}, {{email}}, {{credits}}, {{subscription}}<br>
                                    <strong>Deal/Offer:</strong> {{deal_amount}}, {{deal_credits}}, {{deal_discount}}<br>
                                    <strong>Platform:</strong> {{free_credits}}
                                </small>
                            </div>
                        </div>

                        <!-- Deal/Offer Fields (Optional) -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Deal Amount <small>(optional)</small></label>
                                <input type="text" class="form-control" id="deal_amount" placeholder="e.g., $10">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Deal Credits <small>(optional)</small></label>
                                <input type="text" class="form-control" id="deal_credits" placeholder="e.g., 5000">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Deal Discount <small>(optional)</small></label>
                                <input type="text" class="form-control" id="deal_discount" placeholder="e.g., 50%">
                            </div>
                        </div>

                        <!-- Email Preview -->
                        <div class="mb-3">
                            <label class="form-label">Preview</label>
                            <div class="border rounded p-3 bg-light" id="email_preview" style="min-height: 100px;">
                                <small class="text-muted">Preview will appear here...</small>
                            </div>
                        </div>

                        <!-- Send Options -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="send_test_first">
                                    <label class="form-check-label" for="send_test_first">
                                        Send test email to me first
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="schedule_send">
                                    <label class="form-check-label" for="schedule_send">
                                        Schedule for later
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-info" onclick="previewEmail()">
                        <i class="fas fa-eye me-2"></i>Preview
                    </button>
                    <button type="button" class="btn btn-primary" onclick="sendMarketingEmail()">
                        <i class="fas fa-paper-plane me-2"></i>Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div class="modal fade" id="paymentDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Payment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Transaction ID</label>
                            <div id="payment-detail-transaction-id" class="form-control-plaintext"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Status</label>
                            <div id="payment-detail-status"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">User Email</label>
                            <div id="payment-detail-user-email" class="form-control-plaintext"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Amount</label>
                            <div id="payment-detail-amount" class="form-control-plaintext"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Type</label>
                            <div id="payment-detail-type"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Payment Method</label>
                            <div id="payment-detail-method" class="form-control-plaintext"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Credits Added</label>
                            <div id="payment-detail-credits" class="form-control-plaintext"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Date</label>
                            <div id="payment-detail-date" class="form-control-plaintext"></div>
                        </div>
                    </div>
                    <!-- Error Details Section (shown only for failed payments) -->
                    <div class="row" id="payment-error-section" style="display: none;">
                        <div class="col-12">
                            <hr>
                            <h6 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>Error Details</h6>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Error Code</label>
                            <div id="payment-detail-error-code" class="form-control-plaintext text-danger"></div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Error Message</label>
                            <div id="payment-detail-error-message" class="form-control-plaintext text-danger"></div>
                        </div>
                    </div>
                    <!-- Gateway Response Section (API Response Data) -->
                    <div class="row" id="payment-gateway-section" style="display: none;">
                        <div class="col-12">
                            <hr>
                            <h6 class="text-primary mb-3"><i class="fas fa-code me-2"></i>API Response Data (Stripe/PayPal)</h6>
                        </div>
                        <div class="col-12">
                            <pre id="payment-detail-gateway-response" style="background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 8px; max-height: 300px; overflow: auto; font-size: 12px; white-space: pre-wrap; word-wrap: break-word;"></pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-info" id="copy-gateway-response-btn" style="display: none;" onclick="copyGatewayResponse()">
                        <i class="fas fa-copy me-1"></i> Copy JSON
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Package Modal -->
    <!-- Subscription Plan Modal -->
    <div class="modal fade" id="planModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="planModalTitle">Create Subscription Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="plan-form" onsubmit="savePlan(event)">
                        <input type="hidden" id="plan-id">
                        <div class="mb-3">
                            <label for="plan-name" class="form-label">Plan Name</label>
                            <input type="text" class="form-control" id="plan-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="plan-type" class="form-label">Plan Type</label>
                            <select class="form-select" id="plan-type" required>
                                <option value="free">Free</option>
                                <option value="starter">Starter</option>
                                <option value="basic">Basic</option>
                                <option value="pro">Pro</option>
                                <option value="yearly">Yearly</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="plan-price" class="form-label">Price ($)</label>
                            <input type="number" step="0.01" class="form-control" id="plan-price" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="plan-credits" class="form-label">Credits per Month</label>
                            <input type="number" class="form-control" id="plan-credits" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="plan-max-clones" class="form-label">Max Voice Clones (-1 = Unlimited)</label>
                            <input type="number" class="form-control" id="plan-max-clones" required value="-1">
                        </div>
                        <div class="mb-3">
                            <label for="plan-description" class="form-label">Description</label>
                            <textarea class="form-control" id="plan-description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="plan-features" class="form-label">Features (JSON array or comma-separated)</label>
                            <textarea class="form-control" id="plan-features" rows="4" placeholder='["Feature 1", "Feature 2"] or Feature 1, Feature 2, Feature 3'></textarea>
                            <small class="text-muted">Enter as JSON array or comma-separated values</small>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="plan-active" checked>
                            <label class="form-check-label" for="plan-active">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePlan(event)">Save Plan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Credit Package Modal -->
    <div class="modal fade" id="packageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="packageModalTitle">Create Package</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="package-form">
                        <input type="hidden" id="package-id">
                        <div class="mb-3">
                            <label for="package-name" class="form-label">Package Name</label>
                            <input type="text" class="form-control" id="package-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="package-credits" class="form-label">Credits</label>
                            <input type="number" class="form-control" id="package-credits" required min="1">
                        </div>
                        <div class="mb-3">
                            <label for="package-price" class="form-label">Price ($)</label>
                            <input type="number" step="0.01" class="form-control" id="package-price" required min="0">
                        </div>
                        <div class="mb-3">
                            <label for="package-discount" class="form-label">Discount Percentage</label>
                            <input type="number" class="form-control" id="package-discount" value="0" min="0" max="100">
                        </div>
                        <div class="mb-3">
                            <label for="package-description" class="form-label">Description</label>
                            <textarea class="form-control" id="package-description" rows="3"></textarea>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="package-popular">
                            <label class="form-check-label" for="package-popular">Mark as Popular</label>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="package-active" checked>
                            <label class="form-check-label" for="package-active">Active</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="savePackage()">Save Package</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'js/table_utils.js' %}?v=2.0"></script>
<script>
// CSRF Token setup - Simple solution using window scope only
if (typeof window.getCookie === 'undefined') {
    window.getCookie = function(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
}
// Always use window.csrftoken - NO local variable
if (!window.csrftoken) {
    window.csrftoken = window.getCookie('csrftoken');
}

// Global alert function
function showAlert(message, type = 'info') {
    // Create alert container if it doesn't exist
    let container = document.getElementById('alert-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'alert-container';
        container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        document.body.appendChild(container);
    }

    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type}`;
    alertDiv.style.cssText = `
        padding: 16px 20px;
        margin-bottom: 12px;
        border-radius: 8px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196f3'};
        color: white;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
        font-size: 14px;
        font-weight: 500;
    `;
    alertDiv.textContent = message;

    container.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => alertDiv.remove(), 300);
    }, 5000);
}

// Safe element value/text setters
function safeSetText(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.textContent = value;
    } else {
        console.warn(`Element not found: ${elementId}`);
    }
}

function safeSetValue(elementId, value) {
    const element = document.getElementById(elementId);
    if (element) {
        element.value = value;
    } else {
        console.warn(`Element not found: ${elementId}`);
    }
}

function safeSetChecked(elementId, checked) {
    const element = document.getElementById(elementId);
    if (element) {
        element.checked = checked;
    } else {
        console.warn(`Element not found: ${elementId}`);
    }
}

function safeSetHTML(elementId, html) {
    const element = document.getElementById(elementId);
    if (element) {
        element.innerHTML = html;
    } else {
        console.warn(`Element not found: ${elementId}`);
    }
}

// Tab switching
function switchToTab(tabName) {
    console.log('=== switchToTab called with:', tabName);

    // Remove active class from all tab panels
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));

    // Activate the selected tab panel
    const tabPanel = document.getElementById(tabName + '-tab');
    if (tabPanel) {
        tabPanel.classList.add('active');
        console.log(' Activated tab panel:', tabName + '-tab');
    } else {
        console.error(' Tab panel NOT FOUND:', tabName + '-tab');
        console.error(' This tab does not exist! Falling back to overview.');
        // Fallback to overview if tab doesn't exist
        const overviewPanel = document.getElementById('overview-tab');
        if (overviewPanel) {
            overviewPanel.classList.add('active');
            tabName = 'overview'; // Update tabName for data loading
        }
        return; // Don't continue with missing tab
    }

    // Update sidebar navigation active state
    document.querySelectorAll('.sidebar .nav-link').forEach(link => {
        link.classList.remove('active');
    });

    // Find and activate the corresponding sidebar link
    const sidebarLink = document.querySelector(`.sidebar a[href*="tab=${tabName}"]`);
    if (sidebarLink) {
        sidebarLink.classList.add('active');
        console.log(' Activated sidebar link for tab:', tabName);
    } else if (tabName === 'overview') {
        // Overview tab uses direct admin-dashboard URL without ?tab= parameter
        const overviewLink = document.querySelector('.sidebar a[href*="admin-dashboard"]');
        if (overviewLink && !overviewLink.href.includes('?tab=')) {
            overviewLink.classList.add('active');
            console.log(' Activated overview sidebar link');
        }
    }

    // Update URL without page reload (only if tab exists)
    const url = new URL(window.location);
    url.searchParams.set('tab', tabName);
    window.history.pushState({}, '', url);

    // Load data based on tab
    console.log('Loading data for tab:', tabName);
    loadTabData(tabName);
}

// Note: Tab buttons are hidden (display: none;)
// Navigation is handled by sidebar links in dashboard_base.html
// The sidebar links use ?tab= URL parameters which are handled on page load

// Check URL parameter and switch to tab on page load
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab');

    if (tabParam) {
        switchToTab(tabParam);
    } else {
        // Default to overview tab if no tab specified
        switchToTab('overview');
    }

    // Load initial stats
    loadStats();
});

// Handle browser back/forward buttons
window.addEventListener('popstate', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const tabParam = urlParams.get('tab') || 'overview';

    console.log('popstate - switching to tab:', tabParam);

    // Remove active from all panels and sidebar links
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.sidebar .nav-link').forEach(link => link.classList.remove('active'));

    // Activate correct tab panel
    const tabPanel = document.getElementById(tabParam + '-tab');
    if (tabPanel) {
        tabPanel.classList.add('active');
    }

    // Activate corresponding sidebar link
    const sidebarLink = document.querySelector(`.sidebar a[href*="tab=${tabParam}"]`);
    if (sidebarLink) {
        sidebarLink.classList.add('active');
    } else if (tabParam === 'overview') {
        const overviewLink = document.querySelector('.sidebar a[href*="admin-dashboard"]');
        if (overviewLink && !overviewLink.href.includes('?tab=')) {
            overviewLink.classList.add('active');
        }
    }

    // Load tab data
    loadTabData(tabParam);
});

// Helper function to load tab data
function loadTabData(tabName) {
    console.log('loadTabData called for:', tabName);

    if (tabName === 'users') {
        loadUsers();
    } else if (tabName === 'payments') {
        loadPayments();
    } else if (tabName === 'voices') {
        loadVoices();
    } else if (tabName === 'overview') {
        loadRevenueChart();
        loadActivity();
        loadVoiceCloningStatus(); // Load voice cloning status on overview tab
    } else if (tabName === 'settings') {
        loadPlatformSettings();
    } else if (tabName === 'announcements') {
        loadAnnouncementsTable();
    } else if (tabName === 'email-marketing') {
        loadEmailMarketing();
    } else if (tabName === 'packages') {
        loadSubscriptionPlans();
        loadPackages();
    } else if (tabName === 'database') {
        console.log('Database tab selected - no data loading needed');
        // Database tab doesn't need data loading, it's a separate page
    } else if (tabName === 'voice-cloning') {
        console.log('Voice cloning tab selected - no data loading needed');
        // Voice cloning tab has its own interface
    } else {
        console.warn('Unknown tab:', tabName, '- no data loading handler');
    }
}

// CSRF token is already defined in dashboard_base.html

// Load stats
async function loadStats() {
    try {
        console.log('Loading stats...');
        const response = await fetch('/api/accounts/admin/stats/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        console.log('Stats response status:', response.status);

        if (response.ok) {
            const data = await response.json();
            console.log('Stats data:', data);

            safeSetText('total-users', data.stats.total_users.toLocaleString());
            safeSetText('total-revenue', data.stats.total_revenue.toFixed(2));
            safeSetText('total-clones', data.stats.total_clones.toLocaleString());
            safeSetText('total-generations', data.stats.total_generations.toLocaleString());
            safeSetText('users-registered-today', data.stats.users_registered_today.toLocaleString());
            safeSetText('online-users', data.stats.online_users.toLocaleString());

            // Audio generation stats
            safeSetText('audio-pending', data.stats.audio_pending.toLocaleString());
            safeSetText('audio-processing', data.stats.audio_processing.toLocaleString());
            safeSetText('audio-completed', data.stats.audio_completed.toLocaleString());
            safeSetText('audio-failed', data.stats.audio_failed.toLocaleString());

            console.log('Stats loaded successfully');
        } else {
            console.error('Stats API returned error:', response.status);
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Initialize chart with dynamic data
let revenueChart = null;
async function loadRevenueChart() {
    try {
        const response = await fetch('/api/accounts/admin/revenue-chart/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const ctx = document.getElementById('revenue-chart');
            if (ctx) {
                if (revenueChart) {
                    revenueChart.destroy();
                }
                revenueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.chart.labels,
                        datasets: [{
                            label: 'Revenue',
                            data: data.chart.data,
                            borderColor: '#000000',
                            backgroundColor: 'rgba(0, 0, 0, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
    } catch (error) {
        console.error('Error loading revenue chart:', error);
    }
}

// Load activity feed
async function loadActivity() {
    try {
        const response = await fetch('/api/accounts/admin/activity/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const activityFeed = document.querySelector('.activity-feed');
            activityFeed.innerHTML = '';

            data.activities.forEach(activity => {
                const activityItem = document.createElement('div');
                activityItem.className = 'activity-item';
                const activityTime = new Date(activity.time).toLocaleString();
                activityItem.innerHTML = `
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${activity.title}</strong>
                            <p class="mb-0 text-muted">${activity.description}</p>
                        </div>
                        <div class="activity-time">${activityTime}</div>
                    </div>
                `;
                activityFeed.appendChild(activityItem);
            });
        }
    } catch (error) {
        console.error('Error loading activity:', error);
    }
}

// Users table state
let allUsersData = [];
let filteredUsersData = [];
let usersCurrentPage = 1;
let usersPageSize = 10;
let usersSortColumn = 'username';
let usersSortOrder = 'asc';

// Load users table with pagination and filters
async function loadUsers() {
    try {
        const response = await fetch('/api/accounts/admin/users/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            console.log('[USERS] API Response:', data);
            allUsersData = data.users || [];
            filteredUsersData = [...allUsersData];
            renderUsersTable();
        }
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-table-body').innerHTML =
            '<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger">Failed to load users</div></td></tr>';
    }
}

function filterUsers() {
    const searchQuery = document.getElementById('users-search').value.toLowerCase();
    const planFilter = document.getElementById('users-plan-filter').value;
    const statusFilter = document.getElementById('users-status-filter').value;

    filteredUsersData = allUsersData.filter(user => {
        const matchesSearch = !searchQuery ||
            user.username.toLowerCase().includes(searchQuery) ||
            user.email.toLowerCase().includes(searchQuery);

        const matchesPlan = !planFilter || user.plan === planFilter;
        const matchesStatus = !statusFilter || user.status === statusFilter;

        return matchesSearch && matchesPlan && matchesStatus;
    });

    usersCurrentPage = 1;
    renderUsersTable();
}

function sortUsers(column) {
    if (usersSortColumn === column) {
        usersSortOrder = usersSortOrder === 'asc' ? 'desc' : 'asc';
    } else {
        usersSortColumn = column;
        usersSortOrder = 'asc';
    }

    // Update sort icons
    document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort text-muted';
    });
    const icon = document.getElementById(`sort-${column}`);
    if (icon) {
        icon.className = usersSortOrder === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';
    }

    filteredUsersData.sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        if (column === 'credits') {
            valA = parseInt(valA);
            valB = parseInt(valB);
        }

        if (valA < valB) return usersSortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return usersSortOrder === 'asc' ? 1 : -1;
        return 0;
    });

    renderUsersTable();
}

function changeUsersPageSize() {
    usersPageSize = parseInt(document.getElementById('users-page-size').value);
    usersCurrentPage = 1;
    renderUsersTable();
}

function goToUsersPage(page) {
    const totalPages = Math.ceil(filteredUsersData.length / usersPageSize);
    if (page < 1 || page > totalPages) return;
    usersCurrentPage = page;
    renderUsersTable();
}

function renderUsersTable() {
    const tbody = document.getElementById('users-table-body');
    tbody.innerHTML = '';

    if (filteredUsersData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No users found</td></tr>';
        safeSetText('users-showing-text', 'Showing 0 of 0');
        safeSetHTML('users-pagination', '');
        return;
    }

    // Pagination
    const totalPages = Math.ceil(filteredUsersData.length / usersPageSize);
    const startIdx = (usersCurrentPage - 1) * usersPageSize;
    const endIdx = Math.min(startIdx + usersPageSize, filteredUsersData.length);
    const pageUsers = filteredUsersData.slice(startIdx, endIdx);

    // Render rows
    pageUsers.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><div class="fw-bold">${user.username}</div></td>
            <td>${user.email}</td>
            <td><span class="badge bg-primary">${user.plan}</span></td>
            <td>${user.credits.toLocaleString()}</td>
            <td><span class="badge-status ${user.status}">${user.status}</span></td>
            <td>${new Date(user.joined).toLocaleString()}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick='editUser(${JSON.stringify(user)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-success" onclick="openAddCreditsModal(${user.id})" title="Add Credits">
                        <i class="fas fa-coins"></i>
                    </button>
                    <button class="btn btn-outline-info" onclick="loginAsUser(${user.id}, '${user.email}')" title="Login as User">
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                    <button class="btn btn-outline-warning" onclick="toggleUserStatus(${user.id}, ${user.status === 'active'})" title="Toggle Status">
                        <i class="fas fa-power-off"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="deleteUser(${user.id}, '${user.email}')" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });

    // Update showing text
    document.getElementById('users-showing-text').textContent =
        `Showing ${startIdx + 1} to ${endIdx} of ${filteredUsersData.length}`;

    // Render pagination
    renderUsersPagination(totalPages);
}

function renderUsersPagination(totalPages) {
    const pagination = document.getElementById('users-pagination');
    pagination.innerHTML = '';

    if (totalPages <= 1) return;

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${usersCurrentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); goToUsersPage(${usersCurrentPage - 1})">Previous</a>`;
    pagination.appendChild(prevLi);

    // Page numbers
    const maxPages = 5;
    let startPage = Math.max(1, usersCurrentPage - Math.floor(maxPages / 2));
    let endPage = Math.min(totalPages, startPage + maxPages - 1);

    if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
    }

    if (startPage > 1) {
        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); goToUsersPage(1)">1</a>`;
        pagination.appendChild(li);

        if (startPage > 2) {
            const dots = document.createElement('li');
            dots.className = 'page-item disabled';
            dots.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(dots);
        }
    }

    for (let i = startPage; i <= endPage; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === usersCurrentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); goToUsersPage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }

    if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
            const dots = document.createElement('li');
            dots.className = 'page-item disabled';
            dots.innerHTML = '<span class="page-link">...</span>';
            pagination.appendChild(dots);
        }

        const li = document.createElement('li');
        li.className = 'page-item';
        li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); goToUsersPage(${totalPages})">${totalPages}</a>`;
        pagination.appendChild(li);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${usersCurrentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); goToUsersPage(${usersCurrentPage + 1})">Next</a>`;
    pagination.appendChild(nextLi);
}

// Payments pagination state
let paymentsCurrentPage = 1;
let paymentsTotalPages = 1;

// Load payments table with pagination and filtering
async function loadPayments(page = 1) {
    try {
        paymentsCurrentPage = page;
        const perPage = document.getElementById('payments-per-page')?.value || 25;
        const statusFilter = document.getElementById('payments-status-filter')?.value || '';

        const params = new URLSearchParams({
            page: page,
            per_page: perPage
        });
        if (statusFilter) {
            params.append('status', statusFilter);
        }

        const response = await fetch(`/api/accounts/admin/payments/?${params.toString()}`, {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('payments-table-body');
            tbody.innerHTML = '';

            if (data.payments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-4 text-muted">
                            <i class="fas fa-inbox fa-2x mb-2"></i><br>
                            No payments found
                        </td>
                    </tr>
                `;
            } else {
                data.payments.forEach(payment => {
                    const row = document.createElement('tr');

                    // Prepare error display
                    let errorDisplay = '-';
                    if (payment.status === 'failed' && (payment.error_code || payment.error_message)) {
                        const errorText = payment.error_message || payment.error_code || 'Unknown error';
                        const truncatedError = errorText.length > 30 ? errorText.substring(0, 30) + '...' : errorText;
                        errorDisplay = `<span class="text-danger" title="${escapeHtml(errorText)}"><i class="fas fa-exclamation-circle"></i> ${escapeHtml(truncatedError)}</span>`;
                    }

                    // Get payment method badge
                    const methodBadge = getPaymentMethodBadge(payment.payment_method);

                    row.innerHTML = `
                        <td><input type="checkbox" class="payment-checkbox" value="${payment.id}" onchange="updateDeleteButton()"></td>
                        <td><code>${payment.transaction_id}</code></td>
                        <td>${escapeHtml(payment.user_email)}</td>
                        <td>$${payment.amount.toFixed(2)}</td>
                        <td>${methodBadge}</td>
                        <td><span class="badge bg-info">${payment.type}</span></td>
                        <td>
                            <span class="badge-status ${payment.status}">${payment.status}</span>
                        </td>
                        <td>${errorDisplay}</td>
                        <td>${new Date(payment.date).toLocaleString()}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick='showPaymentDetails(${JSON.stringify(payment).replace(/'/g, "&#39;")})' title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSinglePayment(${payment.id})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Update pagination
            if (data.pagination) {
                paymentsTotalPages = data.pagination.total_pages;
                updatePaymentsPagination(data.pagination);
            }
        }
    } catch (error) {
        const tbody = document.getElementById('payments-table-body');
        tbody.innerHTML = `
            <tr>
                <td colspan="10" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
                    Error loading payments
                </td>
            </tr>
        `;
    }
}

// Escape HTML for safe display
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get payment method badge with icon and color
function getPaymentMethodBadge(method) {
    const methods = {
        'stripe': { icon: 'fab fa-stripe', color: '#635bff', label: 'Stripe' },
        'paypal': { icon: 'fab fa-paypal', color: '#003087', label: 'PayPal' },
        'jazzcash': { icon: 'fas fa-mobile-alt', color: '#e1261c', label: 'JazzCash' },
        'easypaisa': { icon: 'fas fa-mobile-alt', color: '#00a651', label: 'Easypaisa' },
        'manual': { icon: 'fas fa-hand-holding-usd', color: '#6c757d', label: 'Manual' }
    };

    const m = methods[method?.toLowerCase()] || { icon: 'fas fa-credit-card', color: '#6c757d', label: method || 'Unknown' };
    return `<span class="badge" style="background-color: ${m.color}; color: white; font-size: 11px;">
        <i class="${m.icon} me-1"></i>${m.label}
    </span>`;
}

// Update payments pagination controls
function updatePaymentsPagination(pagination) {
    const { page, total_count, total_pages, per_page } = pagination;
    const start = (page - 1) * per_page + 1;
    const end = Math.min(page * per_page, total_count);

    // Update showing info
    const showingInfo = document.getElementById('payments-showing-info');
    if (showingInfo) {
        showingInfo.textContent = total_count > 0
            ? `Showing ${start}-${end} of ${total_count} payments`
            : 'No payments found';
    }

    // Update pagination buttons
    const paginationContainer = document.getElementById('payments-pagination');
    if (!paginationContainer) return;
    paginationContainer.innerHTML = '';

    if (total_pages <= 1) return;

    // Previous button
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${page === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${page > 1 ? 'loadPayments(' + (page - 1) + ')' : ''}"><i class="fas fa-chevron-left"></i></a>`;
    paginationContainer.appendChild(prevLi);

    // Page numbers with ellipsis
    const maxVisiblePages = 5;
    let startPage = Math.max(1, page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(total_pages, startPage + maxVisiblePages - 1);

    if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
    }

    // First page + ellipsis
    if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadPayments(1)">1</a>`;
        paginationContainer.appendChild(firstLi);

        if (startPage > 2) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationContainer.appendChild(ellipsisLi);
        }
    }

    // Page numbers
    for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === page ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadPayments(${i})">${i}</a>`;
        paginationContainer.appendChild(pageLi);
    }

    // Last page + ellipsis
    if (endPage < total_pages) {
        if (endPage < total_pages - 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
            paginationContainer.appendChild(ellipsisLi);
        }

        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); loadPayments(${total_pages})">${total_pages}</a>`;
        paginationContainer.appendChild(lastLi);
    }

    // Next button
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${page === total_pages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); ${page < total_pages ? 'loadPayments(' + (page + 1) + ')' : ''}"><i class="fas fa-chevron-right"></i></a>`;
    paginationContainer.appendChild(nextLi);
}

// Show payment details in modal
function showPaymentDetails(payment) {
    safeSetHTML('payment-detail-transaction-id', `<code>${payment.transaction_id}</code>`);
    safeSetHTML('payment-detail-status', `<span class="badge-status ${payment.status}">${payment.status}</span>`);
    safeSetText('payment-detail-user-email', payment.user_email);
    safeSetText('payment-detail-amount', `$${payment.amount.toFixed(2)}`);
    safeSetHTML('payment-detail-type', `<span class="badge bg-info">${payment.type}</span>`);
    safeSetText('payment-detail-method', payment.payment_method || 'N/A');
    safeSetText('payment-detail-credits', payment.credits || 'N/A');
    safeSetText('payment-detail-date', new Date(payment.date).toLocaleString());

    // Show/hide error section based on payment status
    const errorSection = document.getElementById('payment-error-section');
    if (payment.status === 'failed' && (payment.error_code || payment.error_message)) {
        errorSection.style.display = 'flex';
        safeSetText('payment-detail-error-code', payment.error_code || 'N/A');
        safeSetText('payment-detail-error-message', payment.error_message || 'N/A');
    } else {
        errorSection.style.display = 'none';
    }

    // Show/hide gateway response section
    const gatewaySection = document.getElementById('payment-gateway-section');
    const copyBtn = document.getElementById('copy-gateway-response-btn');
    if (payment.gateway_response && Object.keys(payment.gateway_response).length > 0) {
        gatewaySection.style.display = 'flex';
        copyBtn.style.display = 'inline-block';
        const formattedJson = JSON.stringify(payment.gateway_response, null, 2);
        document.getElementById('payment-detail-gateway-response').textContent = formattedJson;
        // Store for copy function
        window.currentGatewayResponse = formattedJson;
    } else {
        gatewaySection.style.display = 'none';
        copyBtn.style.display = 'none';
        window.currentGatewayResponse = null;
    }

    const modal = new bootstrap.Modal(document.getElementById('paymentDetailsModal'));
    modal.show();
}

// Copy gateway response to clipboard
function copyGatewayResponse() {
    if (window.currentGatewayResponse) {
        navigator.clipboard.writeText(window.currentGatewayResponse).then(function() {
            alert('JSON copied to clipboard!');
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
            // Fallback for older browsers
            const textarea = document.createElement('textarea');
            textarea.value = window.currentGatewayResponse;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('JSON copied to clipboard!');
        });
    }
}

// Load platform settings
async function loadPlatformSettings() {
    try {
        const response = await fetch('/api/accounts/admin/platform-settings/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const settings = data.settings;

            // Populate credit configuration
            safeSetValue('credit-calculation-type', settings.credit_calculation_type);
            safeSetValue('credits-per-unit', settings.credits_per_unit);
            safeSetValue('free-trial-credits', settings.free_trial_credits);
            safeSetValue('free-trial-voice-clones', settings.free_trial_voice_clones);

            // Populate audio settings (IndexTTS2)
            safeSetValue('temperature', settings.temperature || 0.8);
            safeSetValue('top-p', settings.top_p || 0.8);
            safeSetValue('top-k', settings.top_k || 30);
            safeSetValue('num-beams', settings.num_beams || 3);
            safeSetValue('repetition-penalty', settings.repetition_penalty || 10.0);
            safeSetValue('length-penalty', settings.length_penalty || 0.0);
            safeSetValue('max-mel-tokens', settings.max_mel_tokens || 1500);
            safeSetValue('max-text-tokens-per-segment', settings.max_text_tokens_per_segment || 120);
            safeSetValue('diffusion-steps', settings.diffusion_steps || 25);
            safeSetValue('inference-cfg-rate', settings.inference_cfg_rate || 0.7);
            safeSetValue('interval-silence', settings.interval_silence || 200);
            safeSetChecked('do-sample', settings.do_sample !== false);

            // Populate gateway toggles
            safeSetChecked('stripe-enabled', settings.stripe_enabled);
            safeSetChecked('paypal-enabled', settings.paypal_enabled);
            safeSetChecked('jazzcash-enabled', settings.jazzcash_enabled);
            safeSetChecked('easypaisa-enabled', settings.easypaisa_enabled);

            // Store credentials in hidden fields
            safeSetValue('stripe-public-key', settings.stripe_public_key || '');
            safeSetValue('stripe-secret-key', settings.stripe_secret_key || '');
            safeSetValue('stripe-webhook-secret', settings.stripe_webhook_secret || '');
            safeSetValue('paypal-client-id', settings.paypal_client_id || '');
            safeSetValue('paypal-client-secret', settings.paypal_client_secret || '');
            safeSetValue('paypal-mode', settings.paypal_mode || 'sandbox');
            safeSetValue('jazzcash-merchant-id', settings.jazzcash_merchant_id || '');
            safeSetValue('jazzcash-password', settings.jazzcash_password || '');
            safeSetValue('jazzcash-integrity-salt', settings.jazzcash_integrity_salt || '');
            safeSetValue('easypaisa-store-id', settings.easypaisa_store_id || '');
            safeSetValue('easypaisa-password', settings.easypaisa_password || '');

            // Update enabled gateways display
            updateEnabledGatewaysDisplay(settings.enabled_gateways);

            // Show last updated info
            if (settings.updated_by_email) {
                document.getElementById('settings-last-updated').innerHTML = `
                    <small class="text-muted">
                        Last updated: ${new Date(settings.updated_at).toLocaleString()} by ${settings.updated_by_email}
                    </small>
                `;
            }
        }
    } catch (error) {
        console.error('Error loading platform settings:', error);
    }
}

// Save platform settings
async function savePlatformSettings() {
    const settingsData = {
        credit_calculation_type: document.getElementById('credit-calculation-type').value,
        credits_per_unit: parseInt(document.getElementById('credits-per-unit').value),
        free_trial_credits: parseInt(document.getElementById('free-trial-credits').value),
        free_trial_voice_clones: parseInt(document.getElementById('free-trial-voice-clones').value),
        // Audio settings (IndexTTS2)
        temperature: parseFloat(document.getElementById('temperature').value),
        top_p: parseFloat(document.getElementById('top-p').value),
        top_k: parseInt(document.getElementById('top-k').value),
        num_beams: parseInt(document.getElementById('num-beams').value),
        repetition_penalty: parseFloat(document.getElementById('repetition-penalty').value),
        length_penalty: parseFloat(document.getElementById('length-penalty').value),
        max_mel_tokens: parseInt(document.getElementById('max-mel-tokens').value),
        max_text_tokens_per_segment: parseInt(document.getElementById('max-text-tokens-per-segment').value),
        diffusion_steps: parseInt(document.getElementById('diffusion-steps').value),
        inference_cfg_rate: parseFloat(document.getElementById('inference-cfg-rate').value),
        interval_silence: parseInt(document.getElementById('interval-silence').value),
        do_sample: document.getElementById('do-sample').checked,
        // Payment gateways
        stripe_enabled: document.getElementById('stripe-enabled').checked,
        stripe_public_key: document.getElementById('stripe-public-key').value,
        stripe_secret_key: document.getElementById('stripe-secret-key').value,
        stripe_webhook_secret: document.getElementById('stripe-webhook-secret').value,
        paypal_enabled: document.getElementById('paypal-enabled').checked,
        paypal_client_id: document.getElementById('paypal-client-id').value,
        paypal_client_secret: document.getElementById('paypal-client-secret').value,
        paypal_mode: document.getElementById('paypal-mode').value,
        jazzcash_enabled: document.getElementById('jazzcash-enabled').checked,
        jazzcash_merchant_id: document.getElementById('jazzcash-merchant-id').value,
        jazzcash_password: document.getElementById('jazzcash-password').value,
        jazzcash_integrity_salt: document.getElementById('jazzcash-integrity-salt').value,
        easypaisa_enabled: document.getElementById('easypaisa-enabled').checked,
        easypaisa_store_id: document.getElementById('easypaisa-store-id').value,
        easypaisa_password: document.getElementById('easypaisa-password').value,
    };

    try {
        const response = await fetch('/api/accounts/admin/platform-settings/update/', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(settingsData)
        });

        const data = await response.json();

        if (data.success) {
            alert('Platform settings saved successfully!');
            loadPlatformSettings(); // Reload to get updated data
        } else {
            alert('Error saving settings: ' + JSON.stringify(data.errors));
        }
    } catch (error) {
        console.error('Error saving platform settings:', error);
        alert('Error saving platform settings. Please try again.');
    }
}

// Update enabled gateways display
function updateEnabledGatewaysDisplay(gateways) {
    const container = document.getElementById('enabled-gateways-display');
    if (!container) return;

    if (gateways && gateways.length > 0) {
        container.innerHTML = `
            <div class="alert alert-success">
                <strong>Active Payment Gateways:</strong>
                <div class="mt-2">
                    ${gateways.map(g => `<span class="badge bg-success me-2">${g.toUpperCase()}</span>`).join('')}
                </div>
            </div>
        `;
    } else {
        container.innerHTML = `
            <div class="alert alert-warning">
                <strong>No payment gateways are currently enabled.</strong>
                <p class="mb-0 mt-2">Enable at least one payment gateway to accept payments.</p>
            </div>
        `;
    }
}

// Load data on page load
document.addEventListener('DOMContentLoaded', () => {
    console.log('Admin dashboard loading...');
    loadStats();
    loadRevenueChart();
    loadActivity();
    loadPlatformSettings();

    // Also load users and payments data for when tabs are clicked
    console.log('Initial data loaded');
});

// ============================================================================
// USER MANAGEMENT FUNCTIONS
// ============================================================================

// Open create user modal
function openCreateUserModal() {
    document.getElementById('create-user-form').reset();
    const modal = new bootstrap.Modal(document.getElementById('createUserModal'));
    modal.show();
}

// Create user
async function createUser() {
    const form = document.getElementById('create-user-form');
    const formData = new FormData(form);

    const userData = {
        email: formData.get('email'),
        username: formData.get('username'),
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        password: formData.get('password'),
        credits: parseInt(formData.get('credits')),
        subscription_type: formData.get('subscription_type'),
        is_active: formData.get('is_active') === 'on',
        is_staff: formData.get('is_staff') === 'on'
    };

    try {
        const response = await fetch('/api/accounts/admin/users/create/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(userData)
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createUserModal')).hide();
            alert('User created successfully!');
            loadUsers();
            loadStats();
        } else {
            alert('Error creating user: ' + JSON.stringify(data.errors));
        }
    } catch (error) {
        console.error('Error creating user:', error);
        alert('Error creating user. Please try again.');
    }
}

// Edit user
function editUser(user) {
    const form = document.getElementById('edit-user-form');
    form.querySelector('[name="user_id"]').value = user.id;
    form.querySelector('[name="email"]').value = user.email;
    form.querySelector('[name="username"]').value = user.username;
    form.querySelector('[name="first_name"]').value = user.first_name || '';
    form.querySelector('[name="last_name"]').value = user.last_name || '';
    form.querySelector('[name="credits"]').value = user.credits;
    form.querySelector('[name="subscription_type"]').value = user.subscription_type || 'free';
    form.querySelector('[name="is_active"]').checked = user.status === 'active';

    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

// Update user
async function updateUser() {
    const form = document.getElementById('edit-user-form');
    const formData = new FormData(form);

    const userId = formData.get('user_id');
    const userData = {
        email: formData.get('email'),
        username: formData.get('username'),
        first_name: formData.get('first_name'),
        last_name: formData.get('last_name'),
        credits: parseInt(formData.get('credits')),
        subscription_type: formData.get('subscription_type'),
        is_active: formData.get('is_active') === 'on'
    };

    try {
        const response = await fetch(`/api/accounts/admin/users/${userId}/update/`, {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(userData)
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            alert('User updated successfully!');
            loadUsers();
        } else {
            alert('Error updating user: ' + JSON.stringify(data.errors));
        }
    } catch (error) {
        console.error('Error updating user:', error);
        alert('Error updating user. Please try again.');
    }
}

// Delete user
async function deleteUser(userId, userEmail) {
    if (!confirm(`Are you sure you want to delete user ${userEmail}?\n\nThis action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/admin/users/${userId}/delete/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const data = await response.json();

        if (data.success) {
            alert('User deleted successfully!');
            loadUsers();
            loadStats();
        } else {
            alert('Error deleting user: ' + data.error);
        }
    } catch (error) {
        console.error('Error deleting user:', error);
        alert('Error deleting user. Please try again.');
    }
}

// Login as user - Direct login without confirmation
async function loginAsUser(userId, userEmail) {
    try {
        const response = await fetch('/api/accounts/admin/users/login-as/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify({
                user_id: userId
            })
        });

        const data = await response.json();

        if (data.success) {
            // Directly redirect to user dashboard without any alert
            window.location.href = data.redirect_url || '/dashboard/';
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error logging in as user:', error);
        alert('Error logging in as user. Please try again.');
    }
}

// Open add credits modal
function openAddCreditsModal(userId) {
    safeSetValue('credits-user-id', userId);
    safeSetValue('credits-amount', 1000);
    const modal = new bootstrap.Modal(document.getElementById('addCreditsModal'));
    modal.show();
}

// Add credits
async function addCredits() {
    const userId = document.getElementById('credits-user-id').value;
    const amount = parseInt(document.getElementById('credits-amount').value);

    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }

    try {
        const response = await fetch(`/api/accounts/admin/users/${userId}/add-credits/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify({ amount })
        });

        const data = await response.json();

        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addCreditsModal')).hide();
            alert(data.message);
            loadUsers();
        } else {
            alert('Error adding credits: ' + data.error);
        }
    } catch (error) {
        console.error('Error adding credits:', error);
        alert('Error adding credits. Please try again.');
    }
}

// Platform Settings Modal Functions
async function openPlatformSettingsModal() {
    try {
        // Load current settings
        const response = await fetch('/api/accounts/admin/platform-settings/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();
            const settings = data.settings;

            // Populate form
            safeSetValue('credit_calculation_type', settings.credit_calculation_type);
            safeSetValue('credits_per_unit', settings.credits_per_unit);
            safeSetChecked('stripe_enabled', settings.stripe_enabled);
            safeSetChecked('paypal_enabled', settings.paypal_enabled);
            safeSetChecked('jazzcash_enabled', settings.jazzcash_enabled);
            safeSetChecked('easypaisa_enabled', settings.easypaisa_enabled);

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('platformSettingsModal'));
            modal.show();
        } else {
            alert('Failed to load platform settings');
        }
    } catch (error) {
        console.error('Error loading platform settings:', error);
        alert('Error loading platform settings. Please try again.');
    }
}

async function savePlatformSettings() {
    const data = {
        credit_calculation_type: document.getElementById('credit_calculation_type').value,
        credits_per_unit: parseFloat(document.getElementById('credits_per_unit').value),
        stripe_enabled: document.getElementById('stripe_enabled').checked,
        paypal_enabled: document.getElementById('paypal_enabled').checked,
        jazzcash_enabled: document.getElementById('jazzcash_enabled').checked,
        easypaisa_enabled: document.getElementById('easypaisa_enabled').checked
    };

    try {
        const response = await fetch('/api/accounts/admin/platform-settings/update/', {
            method: 'PATCH',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.success) {
            alert('Platform settings updated successfully!');
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('platformSettingsModal')).hide();
        } else {
            alert('Error: ' + (result.errors || 'Failed to update settings'));
        }
    } catch (error) {
        console.error('Error saving platform settings:', error);
        alert('Error saving settings. Please try again.');
    }
}

// Announcement Modal Functions
function openAnnouncementModal() {
    document.getElementById('announcement-form').reset();
    safeSetChecked('announcement_active', true);
    const modal = new bootstrap.Modal(document.getElementById('announcementModal'));
    modal.show();
}

async function loadAnnouncementsTable() {
    try {
        const response = await fetch('/api/accounts/announcements/all/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const data = await response.json();
        const tbody = document.getElementById('announcements-table-body');
        tbody.innerHTML = '';

        if (!data.success || !data.announcements || data.announcements.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4">No announcements found</td></tr>';
            return;
        }

        data.announcements.forEach(announcement => {
            const typeClass = announcement.type === 'danger' ? 'danger' :
                            announcement.type === 'warning' ? 'warning' :
                            announcement.type === 'success' ? 'success' : 'info';

            const priorityClass = announcement.priority === 'high' ? 'danger' :
                                announcement.priority === 'medium' ? 'warning' : 'secondary';

            const statusBadge = announcement.is_active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-secondary">Inactive</span>';

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${announcement.title}</strong><br><small class="text-muted">${announcement.message.substring(0, 100)}...</small></td>
                <td><span class="badge bg-${typeClass}">${announcement.type}</span></td>
                <td><span class="badge bg-${priorityClass}">${announcement.priority}</span></td>
                <td>${statusBadge}</td>
                <td>${announcement.created_by_email || 'N/A'}</td>
                <td>${new Date(announcement.created_at).toLocaleString()}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement(${announcement.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading announcements:', error);
        document.getElementById('announcements-table-body').innerHTML =
            '<tr><td colspan="7" class="text-center py-4"><div class="alert alert-danger">Failed to load announcements</div></td></tr>';
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Are you sure you want to delete this announcement?')) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/announcements/${announcementId}/delete/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('Announcement deleted successfully!');
            loadAnnouncementsTable(); // Reload the table
        } else {
            alert('Error: ' + (result.error || 'Failed to delete announcement'));
        }
    } catch (error) {
        console.error('Error deleting announcement:', error);
        alert('Error deleting announcement. Please try again.');
    }
}

async function createAnnouncement() {
    const title = document.getElementById('announcement_title').value;
    const message = document.getElementById('announcement_message').value;

    if (!title || !message) {
        alert('Please fill in all required fields');
        return;
    }

    const data = {
        title: title,
        message: message,
        type: document.getElementById('announcement_type').value,
        priority: document.getElementById('announcement_priority').value,
        is_active: document.getElementById('announcement_active').checked
    };

    try {
        const response = await fetch('/api/accounts/announcements/create/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Server response:', errorText);
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            alert('Announcement published successfully!');
            bootstrap.Modal.getInstance(document.getElementById('announcementModal')).hide();
            document.getElementById('announcement-form').reset();
            // Reload announcements table if on that tab
            const announcementsTab = document.getElementById('announcements-tab');
            if (announcementsTab && announcementsTab.classList.contains('active')) {
                loadAnnouncementsTable();
            }
        } else {
            alert('Error: ' + (result.error || 'Failed to create announcement'));
        }
    } catch (error) {
        console.error('Error creating announcement:', error);
        alert('Error creating announcement. Please try again.');
    }
}

// Toggle user status
async function toggleUserStatus(userId, isCurrentlyActive) {
    const action = isCurrentlyActive ? 'deactivate' : 'activate';

    if (!confirm(`Are you sure you want to ${action} this user?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/admin/users/${userId}/toggle-status/`, {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(data.message);
            loadUsers();
        } else {
            alert('Error toggling user status: ' + data.error);
        }
    } catch (error) {
        console.error('Error toggling user status:', error);
        alert('Error toggling user status. Please try again.');
    }
}

// ============================================================================
// Talk Studio FUNCTIONALITY
// ============================================================================

document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generate-voice-btn');
    const voiceRefAudio = document.getElementById('voice-ref-audio');
    const synthesisText = document.getElementById('synthesis-text');
    const outputSection = document.getElementById('voice-output-section');
    const progressSection = document.getElementById('voice-progress-section');
    const outputAudio = document.getElementById('output-audio');

    if (generateBtn) {
        generateBtn.addEventListener('click', async function() {
            // Validate inputs
            if (!voiceRefAudio.files || voiceRefAudio.files.length === 0) {
                alert('Please upload a voice reference audio file!');
                return;
            }

            const text = synthesisText.value.trim();
            if (!text) {
                alert('Please enter the text you want to synthesize!');
                return;
            }

            if (text.length > 50000) {
                alert(`Text is too long! Maximum 50,000 characters allowed. Your text has ${text.length} characters.`);
                return;
            }

            // Show progress, hide output
            progressSection.style.display = 'block';
            outputSection.style.display = 'none';
            generateBtn.disabled = true;

            try {
                // Create FormData
                const formData = new FormData();
                formData.append('audio_file', voiceRefAudio.files[0]);
                formData.append('text', text);

                // Call the voice generation API
                const response = await fetch('/api/voice#', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': window.csrftoken
                    },
                    body: formData,
                    credentials: 'same-origin'
                });

                const data = await response.json();

                if (data.success && data.audio_url) {
                    // Show the generated audio
                    outputAudio.src = data.audio_url;
                    outputSection.style.display = 'block';
                    progressSection.style.display = 'none';
                } else {
                    throw new Error(data.error || 'Failed to generate voice');
                }
            } catch (error) {
                console.error('Error generating voice:', error);
                alert('Error generating voice: ' + error.message);
                progressSection.style.display = 'none';
            } finally {
                generateBtn.disabled = false;
            }
        });
    }
});

// ============================================================================
// EMAIL MARKETING FUNCTIONS
// ============================================================================
{% verbatim %}
const emailTemplates = {
    deal: {
        subject: ' Special Deal - {{deal_discount}} OFF for {{username}}!',
        body: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #f4f4f7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #f4f4f7; padding: 40px 0;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 32px; font-weight: 700;"> Special Deal Just for You!</h1>
                        </td>
                    </tr>
                    <!-- Body -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #2d3748; font-size: 24px; margin: 0 0 20px 0;">Hi {{user_name}},</h2>

                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                                We're offering an exclusive <strong style="color: #667eea; font-size: 20px;">{{deal_discount}} OFF</strong> on all credit packages for the next <strong>48 hours</strong>!
                            </p>

                            <table width="100%" cellpadding="15" style="background-color: #f7fafc; border-radius: 8px; margin: 20px 0;">
                                <tr>
                                    <td>
                                        <p style="margin: 10px 0; color: #2d3748; font-size: 16px;"> Clone unlimited voices</p>
                                        <p style="margin: 10px 0; color: #2d3748; font-size: 16px;"> Generate high-quality audio</p>
                                        <p style="margin: 10px 0; color: #2d3748; font-size: 16px;"> Lightning-fast processing</p>
                                    </td>
                                </tr>
                            </table>

                            <div style="background: linear-gradient(to right, #fef3c7, #fde68a); padding: 20px; border-radius: 8px; border-left: 4px solid #f59e0b; margin: 20px 0;">
                                <p style="margin: 0; color: #92400e; font-size: 14px;"> Your current balance</p>
                                <p style="margin: 5px 0 0 0; color: #92400e; font-size: 24px; font-weight: 700;">{{credits}} credits</p>
                            </div>

                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <a href="https://talkstudio.ai/pricing/" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #ffffff; padding: 16px 40px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);">
                                             Get {{deal_credits}} Credits for {{deal_amount}}
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="color: #718096; font-size: 14px; line-height: 1.6; margin: 30px 0 0 0;">
                                Best regards,<br>
                                <strong style="color: #2d3748;">Talk Studio Team</strong>
                            </p>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #f7fafc; padding: 20px 30px; text-align: center; border-top: 1px solid #e2e8f0;">
                            <p style="color: #a0aec0; font-size: 12px; margin: 0;"> 2025 Talk Studio Platform. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`
    },
    feature: {
        subject: ' New Feature - {{username}}, Check This Out!',
        body: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0;">
</head>
<body style="margin: 0; padding: 0; background-color: #ecfdf5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #ecfdf5; padding: 40px 0;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 40px 30px; text-align: center;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 32px; font-weight: 700;"> Exciting New Feature!</h1>
                        </td>
                    </tr>
                    <!-- Body -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #2d3748; font-size: 24px; margin: 0 0 20px 0;">Hi {{user_name}},</h2>

                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                                We've just launched an <strong>amazing new feature</strong> that will revolutionize your Talk Studio experience!
                            </p>

                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 20px 0;">
                                <tr>
                                    <td style="padding: 15px; background-color: #d1fae5; border-radius: 8px; margin-bottom: 10px;">
                                        <p style="margin: 0; color: #065f46; font-size: 16px;"><strong> Enhanced Voice Quality</strong></p>
                                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 14px;">Crystal clear audio with professional-grade output</p>
                                    </td>
                                </tr>
                                <tr><td style="height: 10px;"></td></tr>
                                <tr>
                                    <td style="padding: 15px; background-color: #d1fae5; border-radius: 8px;">
                                        <p style="margin: 0; color: #065f46; font-size: 16px;"><strong> Multiple Emotion Controls</strong></p>
                                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 14px;">Add emotions to your cloned voices - happy, sad, excited!</p>
                                    </td>
                                </tr>
                                <tr><td style="height: 10px;"></td></tr>
                                <tr>
                                    <td style="padding: 15px; background-color: #d1fae5; border-radius: 8px;">
                                        <p style="margin: 0; color: #065f46; font-size: 16px;"><strong> 3x Faster Processing</strong></p>
                                        <p style="margin: 5px 0 0 0; color: #047857; font-size: 14px;">Generate audio in seconds, not minutes</p>
                                    </td>
                                </tr>
                            </table>

                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <a href="http://127.0.0.1:8000/clone/" style="display: inline-block; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: #ffffff; padding: 16px 40px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);">
                                             Try New Features Now
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="color: #718096; font-size: 14px; line-height: 1.6; margin: 30px 0 0 0;">
                                Best regards,<br>
                                <strong style="color: #2d3748;">Talk Studio Team</strong>
                            </p>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #f0fdf4; padding: 20px 30px; text-align: center; border-top: 1px solid #d1fae5;">
                            <p style="color: #6ee7b7; font-size: 12px; margin: 0;"> 2025 Talk Studio Platform. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`
    },
    update: {
        subject: ' System Update - Important Info for {{username}}',
        body: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #fef3c7; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #fef3c7; padding: 40px 0;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 40px 30px; text-align: center;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 32px; font-weight: 700;"> System Update</h1>
                        </td>
                    </tr>
                    <!-- Body -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #2d3748; font-size: 24px; margin: 0 0 20px 0;">Hi {{user_name}},</h2>

                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 20px 0;">
                                We're performing a <strong>system update</strong> to improve your experience and bring you better features!
                            </p>

                            <div style="background-color: #fffbeb; border-left: 4px solid #f59e0b; padding: 20px; border-radius: 8px; margin: 20px 0;">
                                <h3 style="color: #92400e; margin: 0 0 15px 0; font-size: 18px;"> What's Changing:</h3>
                                <p style="margin: 10px 0; color: #78350f; font-size: 15px;"> <strong>40% faster processing</strong> - Your audio generates quicker</p>
                                <p style="margin: 10px 0; color: #78350f; font-size: 15px;"> <strong>Enhanced security</strong> - Your data is safer than ever</p>
                                <p style="margin: 10px 0; color: #78350f; font-size: 15px;"> <strong>Bug fixes</strong> - Smoother, more reliable performance</p>
                                <p style="margin: 10px 0; color: #78350f; font-size: 15px;"> <strong>UI improvements</strong> - Cleaner, easier to use interface</p>
                            </div>

                            <table width="100%" cellpadding="15" style="background-color: #dcfce7; border-radius: 8px; margin: 20px 0;">
                                <tr>
                                    <td align="center">
                                        <p style="margin: 0; color: #166534; font-size: 16px; font-weight: 600;"> No Action Required From You!</p>
                                        <p style="margin: 5px 0 0 0; color: #15803d; font-size: 14px;">The update will happen automatically in the background</p>
                                    </td>
                                </tr>
                            </table>

                            <p style="color: #718096; font-size: 14px; line-height: 1.6; margin: 30px 0 0 0;">
                                Thank you for your patience,<br>
                                <strong style="color: #2d3748;">Talk Studio Team</strong>
                            </p>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #fffbeb; padding: 20px 30px; text-align: center; border-top: 1px solid #fde68a;">
                            <p style="color: #a16207; font-size: 12px; margin: 0;"> 2025 Talk Studio Platform. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`
    },
    promotion: {
        subject: ' Exclusive Offer for {{username}} - Limited Time!',
        body: `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body style="margin: 0; padding: 0; background-color: #fef2f2; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
    <table width="100%" cellpadding="0" cellspacing="0" style="background-color: #fef2f2; padding: 40px 0;">
        <tr>
            <td align="center">
                <table width="600" cellpadding="0" cellspacing="0" style="background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <!-- Header -->
                    <tr>
                        <td style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 40px 30px; text-align: center;">
                            <h1 style="color: #ffffff; margin: 0; font-size: 32px; font-weight: 700;"> Limited Time Offer!</h1>
                            <p style="color: #fecaca; margin: 10px 0 0 0; font-size: 18px;">Ends in 48 hours </p>
                        </td>
                    </tr>
                    <!-- Body -->
                    <tr>
                        <td style="padding: 40px 30px;">
                            <h2 style="color: #2d3748; font-size: 24px; margin: 0 0 20px 0;">Hi {{user_name}},</h2>

                            <div style="background: linear-gradient(to right, #fee2e2, #fecaca); padding: 25px; border-radius: 12px; text-align: center; margin: 20px 0;">
                                <p style="margin: 0; color: #7f1d1d; font-size: 18px; font-weight: 700;"> FLASH SALE ALERT!</p>
                                <p style="margin: 10px 0; color: #991b1b; font-size: 36px; font-weight: 900;">GET {{deal_discount}} OFF</p>
                                <p style="margin: 0; color: #7f1d1d; font-size: 16px;">When you upgrade your plan today!</p>
                            </div>

                            <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 20px 0;">
                                <strong>Your Plan Benefits:</strong>
                            </p>

                            <table width="100%" cellpadding="0" cellspacing="0">
                                <tr>
                                    <td style="width: 50%; padding: 15px; background-color: #fef2f2; border-radius: 8px;">
                                        <p style="margin: 0; color: #991b1b; font-size: 15px; font-weight: 600;"> Premium Voice Quality</p>
                                    </td>
                                    <td style="width: 10px;"></td>
                                    <td style="width: 50%; padding: 15px; background-color: #fef2f2; border-radius: 8px;">
                                        <p style="margin: 0; color: #991b1b; font-size: 15px; font-weight: 600;"> Priority Processing</p>
                                    </td>
                                </tr>
                                <tr><td colspan="3" style="height: 10px;"></td></tr>
                                <tr>
                                    <td style="padding: 15px; background-color: #fef2f2; border-radius: 8px;">
                                        <p style="margin: 0; color: #991b1b; font-size: 15px; font-weight: 600;"> Unlimited Downloads</p>
                                    </td>
                                    <td style="width: 10px;"></td>
                                    <td style="padding: 15px; background-color: #fef2f2; border-radius: 8px;">
                                        <p style="margin: 0; color: #991b1b; font-size: 15px; font-weight: 600;"> Bonus {{deal_credits}} Credits</p>
                                    </td>
                                </tr>
                            </table>

                            <div style="background-color: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; text-align: center;">
                                <p style="margin: 0; color: #78350f; font-size: 14px;">Your Current Credits</p>
                                <p style="margin: 5px 0 0 0; color: #92400e; font-size: 28px; font-weight: 700;">{{credits}}</p>
                            </div>

                            <table width="100%" cellpadding="0" cellspacing="0" style="margin: 30px 0;">
                                <tr>
                                    <td align="center">
                                        <a href="https://talkstudio.ai/pricing/" style="display: inline-block; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #ffffff; padding: 18px 50px; text-decoration: none; border-radius: 8px; font-weight: 700; font-size: 18px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4); text-transform: uppercase;">
                                             Claim This Offer Now
                                        </a>
                                    </td>
                                </tr>
                            </table>

                            <p style="color: #ef4444; font-size: 14px; text-align: center; font-weight: 600; margin: 20px 0;">
                                 Hurry! Offer expires in 48 hours
                            </p>

                            <p style="color: #718096; font-size: 14px; line-height: 1.6; margin: 30px 0 0 0;">
                                Best regards,<br>
                                <strong style="color: #2d3748;">Talk Studio Team</strong>
                            </p>
                        </td>
                    </tr>
                    <!-- Footer -->
                    <tr>
                        <td style="background-color: #fef2f2; padding: 20px 30px; text-align: center; border-top: 1px solid #fee2e2;">
                            <p style="color: #fca5a5; font-size: 12px; margin: 0;"> 2025 Talk Studio Platform. All rights reserved.</p>
                        </td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
</body>
</html>`
    }
};

function openEmailMarketingModal() {
    document.getElementById('email-marketing-form').reset();
    safeSetHTML('email_preview', '<small class="text-muted">Preview will appear here...</small>');
    const modal = new bootstrap.Modal(document.getElementById('emailMarketingModal'));
    modal.show();
}

function loadEmailTemplate() {
    const templateType = document.getElementById('email_template').value;

    if (templateType === 'custom') {
        safeSetValue('email_subject', '');
        safeSetValue('email_body', '');
    } else if (emailTemplates[templateType]) {
        safeSetValue('email_subject', emailTemplates[templateType].subject);
        safeSetValue('email_body', emailTemplates[templateType].body);
        previewEmail();
    }
}

function previewEmail() {
    const body = document.getElementById('email_body').value;
    const preview = document.getElementById('email_preview');
    const dealAmount = document.getElementById('deal_amount').value || '$10';
    const dealCredits = document.getElementById('deal_credits').value || '5,000';
    const dealDiscount = document.getElementById('deal_discount').value || '50%';

    // Replace variables with sample data for preview (using {{}} syntax)
    let previewContent = body
        .replace(/\{\{username\}\}/g, 'john123')
        .replace(/\{\{user_name\}\}/g, 'John Doe')
        .replace(/\{\{email\}\}/g, 'john@example.com')
        .replace(/\{\{credits\}\}/g, '5,000')
        .replace(/\{\{subscription\}\}/g, 'Pro')
        .replace(/\{\{deal_amount\}\}/g, dealAmount)
        .replace(/\{\{deal_credits\}\}/g, dealCredits)
        .replace(/\{\{deal_discount\}\}/g, dealDiscount)
        .replace(/\{\{free_credits\}\}/g, '1,000');

    preview.innerHTML = previewContent;
}

async function loadEmailMarketing() {
    try {
        // Load CSV email lists
        loadEmailLists();

        // Load email campaigns and stats
        const response = await fetch('/api/accounts/admin/email-campaigns/', {
            credentials: 'same-origin',
            headers: {'X-CSRFToken': window.csrftoken}
        });

        if (response.ok) {
            const data = await response.json();

            // Update stats
            if (data.stats) {
                safeSetText('total-users-count', data.stats.total_users);
                safeSetText('active-users-count', data.stats.active_users);
                safeSetText('emails-sent-count', data.stats.total_emails_sent);
                safeSetText('last-campaign-date', data.stats.last_campaign_date);
            }

            // Load campaigns table
            const tbody = document.getElementById('email-campaigns-table-body');
            if (data.campaigns && data.campaigns.length > 0) {
                tbody.innerHTML = data.campaigns.map(campaign => `
                    <tr>
                        <td>
                            <strong>${escapeHtml(campaign.subject)}</strong>
                            ${campaign.is_test ? '<br><span class="badge bg-info">Test</span>' : ''}
                            ${campaign.recipient_source_display ? '<br><span class="badge bg-secondary">' + campaign.recipient_source_display + '</span>' : ''}
                            ${campaign.csv_list_name ? '<br><small class="text-muted">List: ' + escapeHtml(campaign.csv_list_name) + '</small>' : ''}
                        </td>
                        <td>${campaign.recipients_type_display || 'N/A'}</td>
                        <td>
                            <span class="badge bg-success">${campaign.sent_count}</span> /
                            <span class="badge bg-danger">${campaign.failed_count}</span> /
                            <span class="badge bg-warning">${campaign.pending_count}</span>
                            ${campaign.unique_clicks ? '<br><small class="text-info">Clicks: ' + campaign.unique_clicks + ' (' + (campaign.click_rate || 0) + '%)</small>' : ''}
                        </td>
                        <td>${campaign.sent_by_email || 'N/A'}</td>
                        <td><small>${new Date(campaign.created_at).toLocaleString()}</small></td>
                        <td>
                            <span class="badge bg-${campaign.status === 'sent' ? 'success' : campaign.status === 'sending' ? 'warning' : campaign.status === 'failed' ? 'danger' : 'secondary'}">
                                ${campaign.status_display || campaign.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewCampaignDetails(${campaign.id})" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmailCampaign(${campaign.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No campaigns sent yet</td></tr>';
            }

            // Render charts with campaign data
            renderEmailMarketingCharts(data.campaigns || []);
        }
    } catch (error) {
        console.error('Error loading email marketing:', error);
    }
}

// Global chart instances
let campaignPerformanceChart, clickRateChart, recipientSourceChart;

function renderEmailMarketingCharts(campaigns) {
    // Destroy existing charts
    if (campaignPerformanceChart) campaignPerformanceChart.destroy();
    if (clickRateChart) clickRateChart.destroy();
    if (recipientSourceChart) recipientSourceChart.destroy();

    // 1. Campaign Performance Chart (Last 7 days)
    const last7Days = campaigns.slice(0, 7).reverse();
    const perfCtx = document.getElementById('campaignPerformanceChart').getContext('2d');
    campaignPerformanceChart = new Chart(perfCtx, {
        type: 'line',
        data: {
            labels: last7Days.map(c => new Date(c.created_at).toLocaleDateString()),
            datasets: [
                {
                    label: 'Emails Sent',
                    data: last7Days.map(c => c.sent_count),
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Unique Clicks',
                    data: last7Days.map(c => c.unique_clicks || 0),
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.4,
                    fill: true
                },
                {
                    label: 'Failed',
                    data: last7Days.map(c => c.failed_count),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.4,
                    fill: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });

    // 2. Click-Through Rate Chart (Pie)
    const campaignsWithClicks = campaigns.filter(c => c.sent_count > 0).slice(0, 5);
    const clickCtx = document.getElementById('clickRateChart').getContext('2d');
    clickRateChart = new Chart(clickCtx, {
        type: 'doughnut',
        data: {
            labels: campaignsWithClicks.map(c => c.subject.substring(0, 20) + '...'),
            datasets: [{
                label: 'Click Rate (%)',
                data: campaignsWithClicks.map(c => c.click_rate || 0),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + '%';
                        }
                    }
                }
            }
        }
    });

    // 3. Recipient Source Distribution Chart (Bar)
    const sourceCounts = {
        website: 0,
        csv: 0,
        both: 0
    };

    campaigns.forEach(c => {
        const source = c.recipient_source || 'website';
        sourceCounts[source] = (sourceCounts[source] || 0) + c.sent_count;
    });

    const sourceCtx = document.getElementById('recipientSourceChart').getContext('2d');
    recipientSourceChart = new Chart(sourceCtx, {
        type: 'bar',
        data: {
            labels: ['Website Users', 'CSV Lists', 'Both'],
            datasets: [{
                label: 'Emails Sent',
                data: [sourceCounts.website, sourceCounts.csv, sourceCounts.both],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)'
                ],
                borderColor: [
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)',
                    'rgb(75, 192, 192)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

async function sendMarketingEmail() {
    const subject = document.getElementById('email_subject').value;
    const body = document.getElementById('email_body').value;
    const recipientSource = document.getElementById('recipient_source').value;
    const recipients = document.getElementById('email_recipients').value;
    const csvListId = document.getElementById('csv_list_id').value;
    const sendTest = document.getElementById('send_test_first').checked;

    // Get optional deal/offer data
    const dealAmount = document.getElementById('deal_amount').value;
    const dealCredits = document.getElementById('deal_credits').value;
    const dealDiscount = document.getElementById('deal_discount').value;

    if (!subject || !body) {
        alert('Please fill in all required fields');
        return;
    }

    // Validate CSV list is selected when needed
    if ((recipientSource === 'csv' || recipientSource === 'both') && !csvListId) {
        alert('Please select a CSV list');
        return;
    }

    const recipientText = recipientSource === 'csv' ? 'CSV list users' :
                         recipientSource === 'both' ? 'both website and CSV users' :
                         recipients;

    if (!confirm(`Are you sure you want to send this email to ${recipientText}${sendTest ? ' (TEST)' : ''}?`)) {
        return;
    }

    const data = {
        subject: subject,
        body: body,
        recipients: recipients,
        recipient_source: recipientSource,
        csv_list_id: csvListId || null,
        test_mode: sendTest,
        deal_amount: dealAmount || '1000',
        deal_credits: dealCredits || '5000',
        deal_discount: dealDiscount || '50%'
    };

    try {
        const response = await fetch('/api/accounts/admin/send-marketing-email/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(data)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();

        if (result.success) {
            alert(`Email sent successfully!\n\nSent: ${result.sent_count}\nFailed: ${result.failed_count}`);
            bootstrap.Modal.getInstance(document.getElementById('emailMarketingModal')).hide();
            document.getElementById('email-marketing-form').reset();
            loadEmailMarketing();
        } else {
            alert('Error: ' + (result.error || 'Failed to send email'));
        }
    } catch (error) {
        console.error('Error sending email:', error);
        alert('Error sending email. Please try again.');
    }
}

// CSV Upload Functions
function openCSVUploadModal() {
    document.getElementById('csv-upload-form').reset();
    const modal = new bootstrap.Modal(document.getElementById('csvUploadModal'));
    modal.show();
}

async function uploadCSVList() {
    const name = document.getElementById('csv_list_name').value;
    const description = document.getElementById('csv_list_description').value;
    const fileInput = document.getElementById('csv_file');
    const file = fileInput.files[0];

    if (!name || !file) {
        alert('Please provide list name and CSV file');
        return;
    }

    const formData = new FormData();
    formData.append('name', name);
    formData.append('description', description);
    formData.append('csv_file', file);

    try {
        const response = await fetch('/api/accounts/admin/email-lists/upload/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            },
            body: formData
        });

        const result = await response.json();

        if (result.success) {
            alert(result.message);
            bootstrap.Modal.getInstance(document.getElementById('csvUploadModal')).hide();
            loadEmailLists(); // Reload lists
        } else {
            alert('Error: ' + (result.error || 'Failed to upload CSV'));
        }
    } catch (error) {
        console.error('Error uploading CSV:', error);
        alert('Error uploading CSV. Please try again.');
    }
}

async function loadEmailLists() {
    try {
        const response = await fetch('/api/accounts/admin/email-lists/', {
            credentials: 'same-origin',
            headers: {'X-CSRFToken': window.csrftoken}
        });

        if (response.ok) {
            const data = await response.json();
            const tbody = document.getElementById('csv-lists-table-body');

            if (data.email_lists && data.email_lists.length > 0) {
                // Populate table
                tbody.innerHTML = data.email_lists.map(list => `
                    <tr>
                        <td><strong>${escapeHtml(list.name)}</strong></td>
                        <td><span class="badge bg-primary">${list.total_emails}</span></td>
                        <td>${list.uploaded_by_email || 'N/A'}</td>
                        <td><small>${new Date(list.created_at).toLocaleString()}</small></td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteEmailList(${list.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

                // Populate dropdown in email modal
                const csvListSelect = document.getElementById('csv_list_id');
                if (csvListSelect) {
                    const options = data.email_lists.map(list =>
                        `<option value="${list.id}">${escapeHtml(list.name)} (${list.total_emails} emails)</option>`
                    ).join('');
                    csvListSelect.innerHTML = '<option value="">-- Select a CSV List --</option>' + options;
                }
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No CSV lists uploaded yet</td></tr>';

                // Clear dropdown
                const csvListSelect = document.getElementById('csv_list_id');
                if (csvListSelect) {
                    csvListSelect.innerHTML = '<option value="">-- No CSV lists available --</option>';
                }
            }
        }
    } catch (error) {
        console.error('Error loading email lists:', error);
    }
}

function toggleRecipientOptions() {
    const recipientSource = document.getElementById('recipient_source').value;
    const websiteSection = document.getElementById('website-users-section');
    const csvSection = document.getElementById('csv-list-section');

    if (recipientSource === 'website') {
        websiteSection.style.display = 'flex';
        csvSection.style.display = 'none';
        document.getElementById('csv_list_id').removeAttribute('required');
    } else if (recipientSource === 'csv') {
        websiteSection.style.display = 'none';
        csvSection.style.display = 'flex';
        document.getElementById('csv_list_id').setAttribute('required', 'required');
    } else if (recipientSource === 'both') {
        websiteSection.style.display = 'flex';
        csvSection.style.display = 'flex';
        document.getElementById('csv_list_id').setAttribute('required', 'required');
    }
}

async function deleteEmailList(listId) {
    if (!confirm('Are you sure you want to delete this email list?')) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/admin/email-lists/${listId}/delete/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('Email list deleted successfully');
            loadEmailLists();
        } else {
            alert('Error: ' + (result.error || 'Failed to delete email list'));
        }
    } catch (error) {
        console.error('Error deleting email list:', error);
        alert('Error deleting email list. Please try again.');
    }
}

// Delete email campaign
async function deleteEmailCampaign(campaignId) {
    if (!confirm('Are you sure you want to delete this email campaign? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/admin/email-campaigns/${campaignId}/delete/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('Email campaign deleted successfully');
            loadEmailMarketing(); // Reload campaigns table
        } else {
            alert('Error: ' + (result.error || 'Failed to delete email campaign'));
        }
    } catch (error) {
        console.error('Error deleting email campaign:', error);
        alert('Error deleting email campaign. Please try again.');
    }
}

// View campaign details
async function viewCampaignDetails(campaignId) {
    try {
        const response = await fetch(`/api/accounts/admin/email-campaigns/${campaignId}/`, {
            credentials: 'same-origin',
            headers: {'X-CSRFToken': window.csrftoken}
        });

        if (response.ok) {
            const data = await response.json();
            const campaign = data.campaign;
            const recipients = data.recipients || [];
            const statusBreakdown = data.status_breakdown || {};

            // Build recipient details table
            let recipientsHtml = '<div class="table-responsive"><table class="table table-sm">';
            recipientsHtml += '<thead><tr><th>Email</th><th>Username</th><th>Credits</th><th>Status</th></tr></thead><tbody>';

            recipients.forEach(r => {
                const statusBadge = r.status === 'sent' ? 'success' : r.status === 'failed' ? 'danger' : 'warning';
                recipientsHtml += `
                    <tr>
                        <td>${r.email}</td>
                        <td>${r.username || 'N/A'}</td>
                        <td>${r.credits || 0}</td>
                        <td><span class="badge bg-${statusBadge}">${r.status}</span></td>
                    </tr>
                `;
            });
            recipientsHtml += '</tbody></table></div>';

            // Show details in alert (you can create a modal for better UI)
            const message = `
Campaign Details:


Subject: ${campaign.subject}
Sent By: ${campaign.sent_by_email}
Date: ${new Date(campaign.created_at).toLocaleString()}

Status Breakdown:
 Sent: ${campaign.sent_count}
 Failed: ${campaign.failed_count}
 Pending: ${campaign.pending_count}

Total Recipients: ${recipients.length}
            `.trim();

            alert(message);

            // Optionally, you can show detailed recipient list in console
            console.log('Campaign Recipients:', recipients);
        }
    } catch (error) {
        console.error('Error viewing campaign details:', error);
        alert('Error loading campaign details. Please try again.');
    }
}
{% endverbatim %}

// Payment delete functionality
function toggleAllPayments(checkbox) {
    const checkboxes = document.querySelectorAll('.payment-checkbox');
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    updateDeleteButton();
}

function updateDeleteButton() {
    const checkedBoxes = document.querySelectorAll('.payment-checkbox:checked');
    const deleteBtn = document.getElementById('delete-selected-payments-btn');
    deleteBtn.style.display = checkedBoxes.length > 0 ? 'inline-block' : 'none';
}

async function deleteSinglePayment(paymentId) {
    if (!confirm('Are you sure you want to delete this payment? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/payments/${paymentId}/delete/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        const result = await response.json();

        if (result.success) {
            alert('Payment deleted successfully');
            loadPayments(); // Reload payments table
        } else {
            alert('Error: ' + (result.error || 'Failed to delete payment'));
        }
    } catch (error) {
        console.error('Error deleting payment:', error);
        alert('Error deleting payment. Please try again.');
    }
}

async function deleteSelectedPayments() {
    const checkedBoxes = document.querySelectorAll('.payment-checkbox:checked');
    const paymentIds = Array.from(checkedBoxes).map(cb => cb.value);

    if (paymentIds.length === 0) {
        alert('Please select at least one payment to delete');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${paymentIds.length} payment(s)? This action cannot be undone.`)) {
        return;
    }

    try {
        const response = await fetch('/api/payments/delete-multiple/', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify({ payment_ids: paymentIds })
        });

        const result = await response.json();

        if (result.success) {
            alert(`${result.deleted_count} payment(s) deleted successfully`);
            safeSetChecked('select-all-payments', false);
            updateDeleteButton();
            loadPayments(); // Reload payments table
        } else {
            alert('Error: ' + (result.error || 'Failed to delete payments'));
        }
    } catch (error) {
        console.error('Error deleting payments:', error);
        alert('Error deleting payments. Please try again.');
    }
}

// Export payments to CSV
function exportPayments() {
    // Get all payment rows from the table
    const table = document.querySelector('#payments-tab .user-table');
    const rows = table.querySelectorAll('tbody tr');

    if (rows.length === 0) {
        alert('No payments to export');
        return;
    }

    // CSV headers
    let csv = 'Transaction ID,User,Plan,Amount,Status,Payment Method,Date\n';

    // Extract data from each row
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 7) {
            const txnId = cells[1].textContent.trim();
            const user = cells[2].textContent.trim();
            const plan = cells[3].textContent.trim();
            const amount = cells[4].textContent.trim();
            const status = cells[5].textContent.trim();
            const method = cells[6].textContent.trim();
            const date = cells[7]?.textContent.trim() || '';

            csv += `"${txnId}","${user}","${plan}","${amount}","${status}","${method}","${date}"\n`;
        }
    });

    // Create download link
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);

    link.setAttribute('href', url);
    link.setAttribute('download', `payments_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';

    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    alert('Payments exported successfully!');
}

// Package management functionality
async function loadPackages() {
    try {
        const response = await fetch('/api/payments/packages/', {
            credentials: 'same-origin'
        });

        const result = await response.json();
        const packagesGrid = document.getElementById('packages-grid');
        packagesGrid.innerHTML = '';

        // Handle both paginated and non-paginated responses
        const packages = result.results || result;

        if (packages && packages.length > 0) {
            packages.forEach(pkg => {
                const col = document.createElement('div');
                col.className = 'col-md-3';
                col.innerHTML = `
                    <div class="card h-100 ${pkg.is_popular ? 'border-primary' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title">${escapeHtml(pkg.name)}</h5>
                                ${pkg.is_popular ? '<span class="badge bg-primary">Popular</span>' : ''}
                            </div>
                            <h3 class="text-primary">${pkg.credits.toLocaleString()}</h3>
                            <p class="text-muted small">Credits</p>
                            <h4 class="mb-2">$${parseFloat(pkg.price).toFixed(2)}</h4>
                            ${pkg.discount_percentage > 0 ? `<span class="badge bg-success mb-2">Save ${pkg.discount_percentage}%</span>` : ''}
                            <p class="text-muted small">${escapeHtml(pkg.description || '')}</p>
                            <div class="mt-3">
                                <span class="badge ${pkg.is_active ? 'bg-success' : 'bg-secondary'} mb-2">
                                    ${pkg.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="btn-group btn-group-sm w-100 mt-3">
                                <button class="btn btn-outline-primary" onclick='editPackage(${JSON.stringify(pkg)})' title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-outline-danger" onclick="deletePackage(${pkg.id})" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                packagesGrid.appendChild(col);
            });
        } else {
            packagesGrid.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No packages created yet. Create your first package!</p></div>';
        }
    } catch (error) {
        console.error('Error loading packages:', error);
        safeSetHTML('packages-grid', '<div class="col-12 text-center py-5"><p class="text-danger">Error loading packages</p></div>');
    }
}

// Subscription Plans management functionality
async function loadSubscriptionPlans() {
    try {
        const response = await fetch('/api/accounts/subscription-plans/', {
            credentials: 'same-origin'
        });

        const result = await response.json();
        const plansGrid = document.getElementById('subscription-plans-grid');
        plansGrid.innerHTML = '';

        // Handle both paginated and non-paginated responses
        const plans = result.results || result;

        if (plans && plans.length > 0) {
            plans.forEach(plan => {
                const col = document.createElement('div');
                col.className = 'col-md-3';

                // Format credits
                let creditsDisplay = plan.credits_per_month;
                if (plan.credits_per_month >= 1000000) {
                    creditsDisplay = (plan.credits_per_month / 1000000) + 'M';
                } else if (plan.credits_per_month >= 1000) {
                    creditsDisplay = (plan.credits_per_month / 1000) + 'K';
                }

                col.innerHTML = `
                    <div class="card h-100 ${plan.plan_type === 'pro' ? 'border-primary' : ''}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title">${escapeHtml(plan.name)}</h5>
                                ${plan.plan_type === 'pro' ? '<span class="badge bg-primary">Featured</span>' : ''}
                            </div>
                            <h3 class="text-primary">${creditsDisplay}</h3>
                            <p class="text-muted small">Credits per ${plan.plan_type === 'yearly' ? 'year' : 'month'}</p>
                            <h4 class="mb-2">$${parseFloat(plan.price).toFixed(2)}</h4>
                            <p class="text-muted small">${escapeHtml(plan.description || '')}</p>
                            <div class="mt-3">
                                <span class="badge ${plan.is_active ? 'bg-success' : 'bg-secondary'} mb-2">
                                    ${plan.is_active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            <div class="btn-group btn-group-sm w-100 mt-3">
                                <button class="btn btn-outline-primary" onclick='editPlan(${JSON.stringify(plan)})' title="Edit">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-outline-danger" onclick="deletePlan(${plan.id})" title="Delete">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                plansGrid.appendChild(col);
            });
        } else {
            plansGrid.innerHTML = '<div class="col-12 text-center py-5"><p class="text-muted">No subscription plans yet. Run populate_subscription_plans.py to add default plans!</p></div>';
        }
    } catch (error) {
        console.error('Error loading subscription plans:', error);
        safeSetHTML('subscription-plans-grid', '<div class="col-12 text-center py-5"><p class="text-danger">Error loading subscription plans</p></div>');
    }
}

function openCreatePlanModal() {
    safeSetText('planModalTitle', 'Create Subscription Plan');
    document.getElementById('plan-form').reset();
    safeSetValue('plan-id', '');
    safeSetChecked('plan-active', true);
    const modal = new bootstrap.Modal(document.getElementById('planModal'));
    modal.show();
}

function editPlan(plan) {
    safeSetText('planModalTitle', 'Edit Subscription Plan');
    safeSetValue('plan-id', plan.id);
    safeSetValue('plan-name', plan.name);
    safeSetValue('plan-type', plan.plan_type);
    safeSetValue('plan-price', plan.price);
    safeSetValue('plan-credits', plan.credits_per_month);
    safeSetValue('plan-max-clones', plan.max_voice_clones);
    safeSetValue('plan-description', plan.description);
    safeSetValue('plan-features', JSON.stringify(plan.features));
    safeSetChecked('plan-active', plan.is_active);
    const modal = new bootstrap.Modal(document.getElementById('planModal'));
    modal.show();
}

async function savePlan(event) {
    event.preventDefault();

    const planId = document.getElementById('plan-id').value;
    const features = document.getElementById('plan-features').value;

    // Parse features
    let featuresArray = [];
    try {
        featuresArray = JSON.parse(features);
    } catch (e) {
        // If not valid JSON, treat as comma-separated
        featuresArray = features.split(',').map(f => f.trim()).filter(f => f);
    }

    const planData = {
        name: document.getElementById('plan-name').value,
        plan_type: document.getElementById('plan-type').value,
        price: parseFloat(document.getElementById('plan-price').value),
        credits_per_month: parseInt(document.getElementById('plan-credits').value),
        max_voice_clones: parseInt(document.getElementById('plan-max-clones').value),
        description: document.getElementById('plan-description').value,
        features: featuresArray,
        is_active: document.getElementById('plan-active').checked
    };

    try {
        const url = planId ? `/api/accounts/subscription-plans/${planId}/` : '/api/accounts/subscription-plans/';
        const method = planId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify(planData)
        });

        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
            loadSubscriptionPlans();
            alert(planId ? 'Plan updated successfully!' : 'Plan created successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error saving plan:', error);
        alert('Failed to save plan. Please try again.');
    }
}

async function deletePlan(planId) {
    if (!confirm('Are you sure you want to delete this plan?')) {
        return;
    }

    try {
        const response = await fetch(`/api/accounts/subscription-plans/${planId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        });

        if (response.ok) {
            loadSubscriptionPlans();
            alert('Plan deleted successfully!');
        } else {
            alert('Failed to delete plan');
        }
    } catch (error) {
        console.error('Error deleting plan:', error);
        alert('Failed to delete plan. Please try again.');
    }
}

function openCreatePackageModal() {
    safeSetText('packageModalTitle', 'Create Package');
    document.getElementById('package-form').reset();
    safeSetValue('package-id', '');
    safeSetChecked('package-active', true);
    const modal = new bootstrap.Modal(document.getElementById('packageModal'));
    modal.show();
}

function editPackage(pkg) {
    safeSetText('packageModalTitle', 'Edit Package');
    safeSetValue('package-id', pkg.id);
    safeSetValue('package-name', pkg.name);
    safeSetValue('package-credits', pkg.credits);
    safeSetValue('package-price', pkg.price);
    safeSetValue('package-discount', pkg.discount_percentage);
    safeSetValue('package-description', pkg.description || '');
    safeSetChecked('package-popular', pkg.is_popular);
    safeSetChecked('package-active', pkg.is_active);

    const modal = new bootstrap.Modal(document.getElementById('packageModal'));
    modal.show();
}

async function savePackage() {
    const packageId = document.getElementById('package-id').value;
    const data = {
        name: document.getElementById('package-name').value,
        credits: parseInt(document.getElementById('package-credits').value),
        price: parseFloat(document.getElementById('package-price').value),
        discount_percentage: parseInt(document.getElementById('package-discount').value),
        description: document.getElementById('package-description').value,
        is_popular: document.getElementById('package-popular').checked,
        is_active: document.getElementById('package-active').checked
    };

    if (!data.name || !data.credits || data.price === undefined) {
        alert('Please fill in all required fields');
        return;
    }

    try {
        const url = packageId ? `/api/payments/packages/${packageId}/` : '/api/payments/packages/';
        const method = packageId ? 'PUT' : 'POST';

        const response = await fetch(url, {
            method: method,
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': window.csrftoken
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (response.ok) {
            alert(`Package ${packageId ? 'updated' : 'created'} successfully!`);
            bootstrap.Modal.getInstance(document.getElementById('packageModal')).hide();
            loadPackages();
        } else {
            alert('Error: ' + JSON.stringify(result));
        }
    } catch (error) {
        console.error('Error saving package:', error);
        alert('Error saving package. Please try again.');
    }
}

async function deletePackage(packageId) {
    if (!confirm('Are you sure you want to delete this package? This action cannot be undone.')) {
        return;
    }

    try {
        const response = await fetch(`/api/payments/packages/${packageId}/`, {
            method: 'DELETE',
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            alert('Package deleted successfully');
            loadPackages();
        } else {
            const result = await response.json();
            alert('Error: ' + JSON.stringify(result));
        }
    } catch (error) {
        console.error('Error deleting package:', error);
        alert('Error deleting package. Please try again.');
    }
}

// ============================================================================
// VOICE CLONING STATUS TRACKING FUNCTIONS
// ============================================================================

async function loadVoiceCloningStatus() {
    try {
        const response = await fetch('/api/accounts/admin/voice-cloning-status/', {
            credentials: 'same-origin',
            headers: {
                'X-CSRFToken': window.csrftoken
            }
        });

        if (response.ok) {
            const data = await response.json();

            if (data.success) {
                // Update summary cards
                safeSetText('vc-status-pending', data.status_counts.pending);
                safeSetText('vc-status-processing', data.status_counts.processing);
                safeSetText('vc-status-completed', data.status_counts.completed);
                safeSetText('vc-status-failed', data.status_counts.failed);

                // Update badges
                safeSetText('vc-queue-badge', data.status_counts.pending);
                safeSetText('vc-processing-badge', data.status_counts.processing);
                safeSetText('vc-completed-badge', data.status_counts.completed);
                safeSetText('vc-failed-badge', data.status_counts.failed);

                // Populate tables
                populateVCQueueTable(data.pending_records);
                populateVCProcessingTable(data.processing_records);
                populateVCCompletedTable(data.completed_records);
                populateVCFailedTable(data.failed_records);
                populateVCUserStatsTable(data.user_stats);

                // Initialize DataTables after data is loaded
                reinitVCDataTables();
            }
        }
    } catch (error) {
        console.error('Error loading voice cloning status:', error);
    }
}

function populateVCQueueTable(records) {
    const tbody = document.getElementById('vc-queue-tbody');
    if (!tbody) return;

    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No pending voice clones</td></tr>';
        return;
    }

    tbody.innerHTML = records.map(record => `
        <tr>
            <td>
                <strong>${escapeHtml(record.user_username)}</strong><br>
                <small class="text-muted">${escapeHtml(record.user_email)}</small>
            </td>
            <td>
                <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(record.text_preview)}
                </div>
                <small class="text-muted">${record.text_length} chars</small>
            </td>
            <td>${record.characters_used.toLocaleString()}</td>
            <td>${record.credits_used}</td>
            <td><small>${formatDateTime(record.created_at)}</small></td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewVoiceCloneDetails('${record.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteVoiceClone('${record.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function populateVCProcessingTable(records) {
    const tbody = document.getElementById('vc-processing-tbody');
    if (!tbody) return;

    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No voice clones being processed</td></tr>';
        return;
    }

    tbody.innerHTML = records.map(record => `
        <tr>
            <td>
                <strong>${escapeHtml(record.user_username)}</strong><br>
                <small class="text-muted">${escapeHtml(record.user_email)}</small>
            </td>
            <td>
                <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(record.text_preview)}
                </div>
                <small class="text-muted">${record.text_length} chars</small>
            </td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-primary" role="progressbar"
                         style="width: ${record.progress}%"
                         aria-valuenow="${record.progress}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        ${record.progress}%
                    </div>
                </div>
            </td>
            <td><small>${formatDateTime(record.started_at)}</small></td>
            <td>${record.estimated_time ? record.estimated_time + 's' : 'N/A'}</td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewVoiceCloneDetails('${record.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteVoiceClone('${record.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function populateVCCompletedTable(records) {
    const tbody = document.getElementById('vc-completed-tbody');
    if (!tbody) return;

    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No completed voice clones</td></tr>';
        return;
    }

    tbody.innerHTML = records.map(record => `
        <tr>
            <td>
                <strong>${escapeHtml(record.user_username)}</strong><br>
                <small class="text-muted">${escapeHtml(record.user_email)}</small>
            </td>
            <td>
                <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(record.text_preview)}
                </div>
                <small class="text-muted">${record.text_length} chars</small>
            </td>
            <td>${record.duration ? record.duration + 's' : 'N/A'}</td>
            <td>${record.file_size ? formatFileSize(record.file_size) : 'N/A'}</td>
            <td><small>${formatDateTime(record.completed_at)}</small></td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewVoiceCloneDetails('${record.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-success me-1" onclick="downloadVoiceClone('${record.id}')" title="Download Audio">
                    <i class="fas fa-download"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteVoiceClone('${record.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function populateVCFailedTable(records) {
    const tbody = document.getElementById('vc-failed-tbody');
    if (!tbody) return;

    if (records.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No failed voice clones</td></tr>';
        return;
    }

    tbody.innerHTML = records.map(record => `
        <tr>
            <td>
                <strong>${escapeHtml(record.user_username)}</strong><br>
                <small class="text-muted">${escapeHtml(record.user_email)}</small>
            </td>
            <td>
                <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">
                    ${escapeHtml(record.text_preview)}
                </div>
                <small class="text-muted">${record.text_length} chars</small>
            </td>
            <td>
                <span class="text-danger" style="font-size: 12px;">
                    ${record.error_message ? escapeHtml(record.error_message.substring(0, 100)) : 'Unknown error'}
                </span>
            </td>
            <td><small>${formatDateTime(record.created_at)}</small></td>
            <td>
                <button class="btn btn-sm btn-info me-1" onclick="viewVoiceCloneDetails('${record.id}')" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteVoiceClone('${record.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function populateVCUserStatsTable(userStats) {
    const tbody = document.getElementById('vc-users-tbody');
    if (!tbody) return;

    if (userStats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No user activity found</td></tr>';
        return;
    }

    tbody.innerHTML = userStats.map(user => `
        <tr>
            <td><strong>${escapeHtml(user.username)}</strong></td>
            <td>${escapeHtml(user.email)}</td>
            <td><span class="badge bg-warning">${user.pending}</span></td>
            <td><span class="badge bg-primary">${user.processing}</span></td>
            <td><span class="badge bg-success">${user.completed}</span></td>
            <td><span class="badge bg-danger">${user.failed}</span></td>
            <td><strong>${user.total}</strong></td>
        </tr>
    `).join('');
}

// Helper functions
function formatDateTime(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString();
}

function formatFileSize(bytes) {
    if (!bytes) return 'N/A';
    const kb = bytes / 1024;
    if (kb < 1024) {
        return kb.toFixed(2) + ' KB';
    }
    const mb = kb / 1024;
    return mb.toFixed(2) + ' MB';
}

// Get status badge HTML
function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-warning">Pending</span>',
        'processing': '<span class="badge bg-info">Processing</span>',
        'completed': '<span class="badge bg-success">Completed</span>',
        'failed': '<span class="badge bg-danger">Failed</span>'
    };
    return badges[status] || '<span class="badge bg-secondary">' + status + '</span>';
}

// View voice clone details in a modal
function viewVoiceCloneDetails(id) {
    fetch(`/api/accounts/admin/voice-clones/${id}/`)
        .then(response => {
            if (!response.ok) throw new Error('Failed to fetch details');
            return response.json();
        })
        .then(data => {
            // Create or get modal
            let modal = document.getElementById('voiceCloneDetailsModal');
            if (!modal) {
                modal = createDetailsModal();
            }

            // Populate modal with data
            document.getElementById('modal-vc-id').textContent = data.id || 'N/A';
            document.getElementById('modal-vc-user').textContent = data.user_username || 'N/A';
            document.getElementById('modal-vc-email').textContent = data.user_email || 'N/A';
            document.getElementById('modal-vc-text').textContent = data.text || 'N/A';

            // Voice information with highlighting
            const voiceSourceElem = document.getElementById('modal-vc-voice-source');
            voiceSourceElem.innerHTML = data.voice_source ?
                `<span class="badge bg-primary">${data.voice_source}</span>` : 'N/A';

            const libraryVoiceElem = document.getElementById('modal-vc-library-voice');
            libraryVoiceElem.innerHTML = data.library_voice ?
                `<strong class="text-success">${data.library_voice}</strong>` :
                '<span class="text-muted">Not used</span>';

            const clonedVoiceElem = document.getElementById('modal-vc-cloned-voice');
            clonedVoiceElem.innerHTML = data.cloned_voice ?
                `<strong class="text-info"><i class="fas fa-microphone-alt me-1"></i>${data.cloned_voice}</strong>` :
                '<span class="text-muted">Not used</span>';

            // Status and settings
            const statusBadge = getStatusBadge(data.status);
            document.getElementById('modal-vc-status').innerHTML = statusBadge;
            document.getElementById('modal-vc-speed').textContent = data.speed || 'N/A';
            document.getElementById('modal-vc-pitch').textContent = data.pitch || 'N/A';
            document.getElementById('modal-vc-tone').textContent = data.tone || 'N/A';

            // File information
            document.getElementById('modal-vc-duration').textContent = data.duration ? data.duration + 's' : 'N/A';
            document.getElementById('modal-vc-file-size').textContent = data.file_size ? formatFileSize(data.file_size) : 'N/A';

            // Usage and timestamps
            document.getElementById('modal-vc-credits').textContent = data.credits_used || '0';
            document.getElementById('modal-vc-chars').textContent = data.characters_used || '0';
            document.getElementById('modal-vc-created').textContent = formatDateTime(data.created_at);
            document.getElementById('modal-vc-completed').textContent = data.completed_at ? formatDateTime(data.completed_at) : 'N/A';
            document.getElementById('modal-vc-error').textContent = data.error_message || 'None';

            // Show generated audio player if available
            const audioContainer = document.getElementById('modal-vc-audio-container');
            const audioPlayer = document.getElementById('modal-vc-audio');
            if (data.audio_file && data.status === 'completed') {
                audioPlayer.src = data.audio_file;
                audioContainer.style.display = 'block';
            } else {
                audioContainer.style.display = 'none';
            }

            // Show cloned voice reference audio if available
            const clonedVoiceAudioContainer = document.getElementById('modal-vc-cloned-audio-container');
            const clonedVoiceAudioPlayer = document.getElementById('modal-vc-cloned-audio');
            if (data.cloned_voice_audio) {
                clonedVoiceAudioPlayer.src = data.cloned_voice_audio;
                clonedVoiceAudioContainer.style.display = 'block';
            } else {
                clonedVoiceAudioContainer.style.display = 'none';
            }

            // Show library voice audio if available
            const libraryVoiceAudioContainer = document.getElementById('modal-vc-library-audio-container');
            const libraryVoiceAudioPlayer = document.getElementById('modal-vc-library-audio');
            if (data.library_voice_audio) {
                libraryVoiceAudioPlayer.src = data.library_voice_audio;
                libraryVoiceAudioContainer.style.display = 'block';
            } else {
                libraryVoiceAudioContainer.style.display = 'none';
            }

            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to load voice clone details: ' + error.message);
        });
}

// Delete voice clone with confirmation
function deleteVoiceClone(id) {
    if (!confirm('{% trans "Are you sure you want to delete this voice clone? This action cannot be undone." %}')) {
        return;
    }

    // Show loading notification
    showToast('{% trans "Deleting voice clone..." %}', 'info');

    fetch('/api/accounts/admin/voice-cloning/delete/', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ audio_id: id })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('{% trans "Voice clone deleted successfully!" %}', 'success');
                // Reload the voice cloning status after a short delay
                setTimeout(() => {
                    loadVoiceCloningStatus();
                }, 500);
            } else {
                throw new Error(data.error || '{% trans "Failed to delete voice clone" %}');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('{% trans "Error: " %}' + error.message, 'danger');
        });
}

// Download voice clone audio
function downloadVoiceClone(id) {
    // Show loading toast
    showToast('{% trans "Preparing download..." %}', 'info');

    // Create a temporary link and trigger download
    const link = document.createElement('a');
    link.href = `/api/accounts/admin/voice-clones/${id}/download/`;
    link.download = `voice_clone_${id}.wav`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);

    // Show success message after a delay
    setTimeout(() => {
        showToast('{% trans "Download started" %}', 'success');
    }, 500);
}

// Helper function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Show toast notification
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
        document.body.appendChild(toastContainer);
    }

    // Create toast element
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show`;
    toast.style.cssText = 'min-width: 300px; margin-bottom: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;

    toastContainer.appendChild(toast);

    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 150);
    }, 5000);
}

// Create details modal dynamically
function createDetailsModal() {
    const modalHTML = `
        <div class="modal fade" id="voiceCloneDetailsModal" tabindex="-1" aria-labelledby="voiceCloneDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="voiceCloneDetailsModalLabel">Voice Clone Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <table class="table table-bordered">
                            <tbody>
                                <tr>
                                    <th style="width: 30%;">ID</th>
                                    <td id="modal-vc-id"></td>
                                </tr>
                                <tr>
                                    <th>User</th>
                                    <td id="modal-vc-user"></td>
                                </tr>
                                <tr>
                                    <th>Email</th>
                                    <td id="modal-vc-email"></td>
                                </tr>
                                <tr>
                                    <th>Text</th>
                                    <td id="modal-vc-text" style="word-break: break-word; white-space: pre-wrap;"></td>
                                </tr>
                                <tr>
                                    <th>Voice Source</th>
                                    <td id="modal-vc-voice-source"></td>
                                </tr>
                                <tr>
                                    <th>Library Voice</th>
                                    <td id="modal-vc-library-voice"></td>
                                </tr>
                                <tr>
                                    <th>Cloned Voice</th>
                                    <td id="modal-vc-cloned-voice"></td>
                                </tr>
                                <tr>
                                    <th>Status</th>
                                    <td id="modal-vc-status"></td>
                                </tr>
                                <tr>
                                    <th>Speed</th>
                                    <td id="modal-vc-speed"></td>
                                </tr>
                                <tr>
                                    <th>Pitch</th>
                                    <td id="modal-vc-pitch"></td>
                                </tr>
                                <tr>
                                    <th>Tone</th>
                                    <td id="modal-vc-tone"></td>
                                </tr>
                                <tr>
                                    <th>Duration</th>
                                    <td id="modal-vc-duration"></td>
                                </tr>
                                <tr>
                                    <th>File Size</th>
                                    <td id="modal-vc-file-size"></td>
                                </tr>
                                <tr>
                                    <th>Credits Used</th>
                                    <td id="modal-vc-credits"></td>
                                </tr>
                                <tr>
                                    <th>Characters Used</th>
                                    <td id="modal-vc-chars"></td>
                                </tr>
                                <tr>
                                    <th>Created At</th>
                                    <td id="modal-vc-created"></td>
                                </tr>
                                <tr>
                                    <th>Completed At</th>
                                    <td id="modal-vc-completed"></td>
                                </tr>
                                <tr>
                                    <th>Error Message</th>
                                    <td id="modal-vc-error" class="text-danger" style="word-break: break-word;"></td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Reference Audio Players -->
                        <div id="modal-vc-cloned-audio-container" style="display: none; margin-top: 20px;">
                            <h6 class="text-info"><i class="fas fa-microphone-alt me-2"></i>Cloned Voice Reference Audio</h6>
                            <audio id="modal-vc-cloned-audio" controls class="w-100" style="margin-top: 10px;"></audio>
                        </div>

                        <div id="modal-vc-library-audio-container" style="display: none; margin-top: 20px;">
                            <h6 class="text-success"><i class="fas fa-book-open me-2"></i>Library Voice Audio</h6>
                            <audio id="modal-vc-library-audio" controls class="w-100" style="margin-top: 10px;"></audio>
                        </div>

                        <!-- Generated Audio Player -->
                        <div id="modal-vc-audio-container" style="display: none; margin-top: 20px;">
                            <h6 class="text-primary"><i class="fas fa-file-audio me-2"></i>Generated Audio Preview</h6>
                            <audio id="modal-vc-audio" controls class="w-100" style="margin-top: 10px;"></audio>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    return document.getElementById('voiceCloneDetailsModal');
}

// DataTable instances
let vcQueueTable, vcProcessingTable, vcCompletedTable, vcFailedTable;

// Initialize DataTables
function initVCDataTables() {
    const commonConfig = {
        pageLength: 25,
        lengthMenu: [[10, 25, 50, 100, 500, 1000, 10000], [10, 25, 50, 100, 500, 1000, 10000]],
        order: [],
        responsive: true,
        language: {
            search: "{% trans 'Search:' %}",
            lengthMenu: "{% trans 'Show _MENU_ entries' %}",
            info: "{% trans 'Showing _START_ to _END_ of _TOTAL_ entries' %}",
            infoEmpty: "{% trans 'No entries available' %}",
            infoFiltered: "{% trans '(filtered from _MAX_ total entries)' %}",
            paginate: {
                first: "{% trans 'First' %}",
                last: "{% trans 'Last' %}",
                next: "{% trans 'Next' %}",
                previous: "{% trans 'Previous' %}"
            },
            emptyTable: "{% trans 'No data available' %}"
        },
        dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
        destroy: true
    };

    // Initialize each table only if it has data rows
    try {
        if ($('#vc-queue-table tbody tr').length > 0 && $('#vc-queue-table tbody tr td[colspan]').length === 0) {
            if (vcQueueTable) vcQueueTable.destroy();
            vcQueueTable = $('#vc-queue-table').DataTable({
                ...commonConfig,
                columnDefs: [{ orderable: false, targets: 5 }]
            });
        }
    } catch(e) { console.log('Queue table init:', e); }

    try {
        if ($('#vc-processing-table tbody tr').length > 0 && $('#vc-processing-table tbody tr td[colspan]').length === 0) {
            if (vcProcessingTable) vcProcessingTable.destroy();
            vcProcessingTable = $('#vc-processing-table').DataTable({
                ...commonConfig,
                columnDefs: [{ orderable: false, targets: 5 }]
            });
        }
    } catch(e) { console.log('Processing table init:', e); }

    try {
        if ($('#vc-completed-table tbody tr').length > 0 && $('#vc-completed-table tbody tr td[colspan]').length === 0) {
            if (vcCompletedTable) vcCompletedTable.destroy();
            vcCompletedTable = $('#vc-completed-table').DataTable({
                ...commonConfig,
                columnDefs: [{ orderable: false, targets: 5 }]
            });
        }
    } catch(e) { console.log('Completed table init:', e); }

    try {
        if ($('#vc-failed-table tbody tr').length > 0 && $('#vc-failed-table tbody tr td[colspan]').length === 0) {
            if (vcFailedTable) vcFailedTable.destroy();
            vcFailedTable = $('#vc-failed-table').DataTable({
                ...commonConfig,
                columnDefs: [{ orderable: false, targets: 4 }]
            });
        }
    } catch(e) { console.log('Failed table init:', e); }
}

// Reinitialize DataTables after data load
function reinitVCDataTables() {
    setTimeout(() => {
        initVCDataTables();
    }, 100);
}
</script>

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
{% endblock %}
