{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "My Generated Audios" %}{% endblock %}

{% block extra_css %}
<style>
    .audio-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 16px;
        transition: all 0.3s ease;
    }

    .audio-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    .audio-controls {
        margin-top: 12px;
    }

    .audio-controls audio {
        width: 100%;
        max-width: 500px;
    }

    .badge-custom {
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .text-preview {
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
        color: var(--text-secondary);
    }

    .text-preview.expanded {
        max-height: none;
    }

    .expand-btn {
        cursor: pointer;
        color: var(--primary);
        font-size: 0.875rem;
    }

    .filter-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }

    .stats-card {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
    }

    .stats-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary);
    }

    .stats-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-top: 4px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{% trans "My Generated Audios" %}</h2>
        <a href="{% url 'clone' %}" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>{% trans "Generate New Audio" %}
        </a>
    </div>

    <!-- Statistics -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value" id="total-audios">0</div>
                <div class="stats-label">{% trans "Total Audios" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value" id="total-characters">0</div>
                <div class="stats-label">{% trans "Characters Used" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value" id="total-credits">0</div>
                <div class="stats-label">{% trans "Credits Spent" %}</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stats-card">
                <div class="stats-value" id="remaining-credits">{{ user.credits }}</div>
                <div class="stats-label">{% trans "Credits Remaining" %}</div>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <div class="row g-3">
            <div class="col-md-4">
                <label for="search-text" class="form-label">{% trans "Search by text" %}</label>
                <input type="text" class="form-control" id="search-text" placeholder="{% trans 'Search...' %}">
            </div>
            <div class="col-md-3">
                <label for="sort-by" class="form-label">{% trans "Sort by" %}</label>
                <select class="form-select" id="sort-by">
                    <option value="-created_at">{% trans "Newest First" %}</option>
                    <option value="created_at">{% trans "Oldest First" %}</option>
                    <option value="-credits_used">{% trans "Most Credits" %}</option>
                    <option value="credits_used">{% trans "Least Credits" %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="filter-date" class="form-label">{% trans "Date Range" %}</label>
                <select class="form-select" id="filter-date">
                    <option value="all">{% trans "All Time" %}</option>
                    <option value="today">{% trans "Today" %}</option>
                    <option value="week">{% trans "This Week" %}</option>
                    <option value="month">{% trans "This Month" %}</option>
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-outline-primary w-100" id="apply-filters">
                    <i class="fas fa-filter me-2"></i>{% trans "Apply" %}
                </button>
            </div>
        </div>
    </div>

    <!-- Audio List -->
    <div id="audio-list">
        <!-- Audio cards will be loaded here dynamically -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{% trans "Loading..." %}</span>
            </div>
            <p class="mt-3 text-muted">{% trans "Loading your audio files..." %}</p>
        </div>
    </div>

    <!-- Pagination -->
    <nav aria-label="Audio pagination" id="pagination-container" class="mt-4" style="display: none;">
        <ul class="pagination justify-content-center" id="pagination">
        </ul>
    </nav>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "Delete Audio" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% trans "Are you sure you want to delete this audio? This action cannot be undone." %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
                <button type="button" class="btn btn-danger" id="confirm-delete">{% trans "Delete" %}</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Translation strings
    const translations = {
        'loadingError': "{% trans 'Failed to load audios. Please try again.' %}",
        'retry': "{% trans 'Retry' %}",
        'noAudios': "{% trans 'No audio files found. Generate your first audio!' %}",
        'generateAudio': "{% trans 'Generate Audio' %}",
        'audio': "{% trans 'Audio' %}",
        'chars': "{% trans 'chars' %}",
        'credits': "{% trans 'credits' %}",
        'download': "{% trans 'Download' %}",
        'delete': "{% trans 'Delete' %}",
        'showMore': "{% trans 'Show more' %}",
        'showLess': "{% trans 'Show less' %}",
        'browserNotSupport': "{% trans 'Your browser does not support the audio element.' %}",
        'previous': "{% trans 'Previous' %}",
        'next': "{% trans 'Next' %}",
        'deleteSuccess': "{% trans 'Audio deleted successfully' %}",
        'deleteFailed': "{% trans 'Failed to delete audio' %}",
        'unknown': "{% trans 'Unknown' %}"
    };

    let currentPage = 1;
    let totalPages = 1;
    let audioToDelete = null;

    // Load audios
    async function loadAudios(page = 1) {
        try {
            const searchText = document.getElementById('search-text').value;
            const sortBy = document.getElementById('sort-by').value;
            const filterDate = document.getElementById('filter-date').value;

            let url = `/api/voices/generated/?page=${page}&ordering=${sortBy}`;

            if (searchText) {
                url += `&search=${encodeURIComponent(searchText)}`;
            }

            if (filterDate !== 'all') {
                url += `&date_range=${filterDate}`;
            }

            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to load audios');
            }

            const data = await response.json();
            renderAudios(data.results || data);
            updateStatistics(data.results || data);

            // Handle pagination
            if (data.count) {
                totalPages = Math.ceil(data.count / (data.results.length || 10));
                currentPage = page;
                renderPagination();
            }

        } catch (error) {
            console.error('Error loading audios:', error);
            document.getElementById('audio-list').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-circle fa-3x text-danger mb-3"></i>
                    <p class="text-muted">${translations.loadingError}</p>
                    <button class="btn btn-primary" onclick="loadAudios()">${translations.retry}</button>
                </div>
            `;
        }
    }

    // Render audios
    function renderAudios(audios) {
        const audioList = document.getElementById('audio-list');

        if (audios.length === 0) {
            audioList.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-music fa-3x text-muted mb-3"></i>
                    <p class="text-muted">${translations.noAudios}</p>
                    <a href="/clone/" class="btn btn-primary mt-3">
                        <i class="fas fa-plus me-2"></i>${translations.generateAudio}
                    </a>
                </div>
            `;
            return;
        }

        audioList.innerHTML = audios.map((audio, index) => `
            <div class="audio-card" data-audio-id="${audio.id}">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <h5 class="mb-1">${translations.audio} #${audio.id.slice(0, 8)}</h5>
                        <div class="d-flex gap-2 flex-wrap">
                            <span class="badge bg-primary badge-custom">
                                <i class="fas fa-font me-1"></i>${audio.characters_used} ${translations.chars}
                            </span>
                            <span class="badge bg-success badge-custom">
                                <i class="fas fa-coins me-1"></i>${audio.credits_used} ${translations.credits}
                            </span>
                            ${audio.duration ? `
                                <span class="badge bg-info badge-custom">
                                    <i class="fas fa-clock me-1"></i>${formatDuration(audio.duration)}
                                </span>
                            ` : ''}
                            <span class="badge bg-secondary badge-custom">
                                <i class="fas fa-file me-1"></i>${formatFileSize(audio.file_size)}
                            </span>
                        </div>
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>${new Date(audio.created_at).toLocaleString()}
                        </small>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="${audio.audio_file}" download>
                                <i class="fas fa-download me-2"></i>${translations.download}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteAudio('${audio.id}'); return false;">
                                <i class="fas fa-trash me-2"></i>${translations.delete}
                            </a></li>
                        </ul>
                    </div>
                </div>

                <div class="text-preview" id="text-${index}">
                    ${audio.text}
                </div>
                ${audio.text.length > 150 ? `
                    <a href="#" class="expand-btn" onclick="toggleText(${index}); return false;">
                        <i class="fas fa-chevron-down me-1"></i>${translations.showMore}
                    </a>
                ` : ''}

                <div class="audio-controls">
                    <audio controls>
                        <source src="${audio.audio_file}" type="audio/wav">
                        ${translations.browserNotSupport}
                    </audio>
                </div>
            </div>
        `).join('');
    }

    // Update statistics
    function updateStatistics(audios) {
        const totalAudios = audios.length;
        const totalCharacters = audios.reduce((sum, audio) => sum + audio.characters_used, 0);
        const totalCredits = audios.reduce((sum, audio) => sum + audio.credits_used, 0);

        document.getElementById('total-audios').textContent = totalAudios;
        document.getElementById('total-characters').textContent = totalCharacters.toLocaleString();
        document.getElementById('total-credits').textContent = totalCredits.toLocaleString();
    }

    // Render pagination
    function renderPagination() {
        if (totalPages <= 1) {
            document.getElementById('pagination-container').style.display = 'none';
            return;
        }

        document.getElementById('pagination-container').style.display = 'block';
        const pagination = document.getElementById('pagination');

        let html = '';

        // Previous button
        html += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAudios(${currentPage - 1}); return false;">${translations.previous}</a>
            </li>
        `;

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                html += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="loadAudios(${i}); return false;">${i}</a>
                    </li>
                `;
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }

        // Next button
        html += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadAudios(${currentPage + 1}); return false;">${translations.next}</a>
            </li>
        `;

        pagination.innerHTML = html;
    }

    // Toggle text expansion
    function toggleText(index) {
        const textEl = document.getElementById(`text-${index}`);
        const btnEl = textEl.nextElementSibling;

        if (textEl.classList.contains('expanded')) {
            textEl.classList.remove('expanded');
            btnEl.innerHTML = `<i class="fas fa-chevron-down me-1"></i>${translations.showMore}`;
        } else {
            textEl.classList.add('expanded');
            btnEl.innerHTML = `<i class="fas fa-chevron-up me-1"></i>${translations.showLess}`;
        }
    }

    // Delete audio
    function deleteAudio(audioId) {
        audioToDelete = audioId;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }

    // Confirm delete
    document.getElementById('confirm-delete').addEventListener('click', async () => {
        if (!audioToDelete) return;

        try {
            const response = await fetch(`/api/voices/generated/${audioToDelete}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error('Failed to delete audio');
            }

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
            modal.hide();

            // Reload audios
            loadAudios(currentPage);

            // Show success message
            showNotification(translations.deleteSuccess, 'success');

        } catch (error) {
            console.error('Error deleting audio:', error);
            showNotification(translations.deleteFailed, 'error');
        }
    });

    // Format duration
    function formatDuration(seconds) {
        if (!seconds) return translations.unknown;
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return minutes > 0 ? `${minutes}m ${secs}s` : `${secs}s`;
    }

    // Format file size
    function formatFileSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB'];
        if (bytes === 0) return '0 B';
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
    }

    // Show notification
    function showNotification(message, type = 'info') {
        // You can implement a toast notification here
        alert(message);
    }

    // Apply filters
    document.getElementById('apply-filters').addEventListener('click', () => {
        loadAudios(1);
    });

    // Search on enter
    document.getElementById('search-text').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            loadAudios(1);
        }
    });

    // Load audios on page load
    document.addEventListener('DOMContentLoaded', () => {
        loadAudios();
    });
</script>
{% endblock %}
