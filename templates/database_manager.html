<!-- Database Management Tab -->
<div class="tab-panel" id="database-tab">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h5 class="mb-0"><i class="fas fa-database me-2"></i>Database Manager</h5>
        <button class="btn btn-primary" onclick="showDatabaseSettings()">
            <i class="fas fa-cog me-2"></i>Database Settings
        </button>
    </div>

    <!-- Database Type Selector -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h6 class="mb-2">Current Database</h6>
                    <div class="d-flex align-items-center">
                        <div class="badge bg-success me-2" id="db-type-badge">SQLite</div>
                        <span class="text-muted small" id="db-connection-status">Connected</span>
                    </div>
                </div>
                <div class="col-md-6 text-end">
                    <button class="btn btn-sm btn-outline-primary" onclick="testDatabaseConnection()">
                        <i class="fas fa-plug me-1"></i>Test Connection
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshDatabaseInfo()">
                        <i class="fas fa-sync me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Browser Tabs -->
    <ul class="nav nav-tabs mb-3" id="dbTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tables-tab" data-bs-toggle="tab" data-bs-target="#tables-panel" type="button">
                <i class="fas fa-table me-1"></i>Tables Browser
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="query-tab" data-bs-toggle="tab" data-bs-target="#query-panel" type="button">
                <i class="fas fa-code me-1"></i>SQL Query
            </button>
        </li>
    </ul>

    <div class="tab-content" id="dbTabsContent">
        <!-- Tables Browser Panel -->
        <div class="tab-pane fade show active" id="tables-panel">
            <div class="row">
                <!-- Tables List -->
                <div class="col-md-3">
                    <div class="card">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Tables</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="tables-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Data View -->
                <div class="col-md-9">
                    <div class="card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" id="current-table-name">Select a table</h6>
                            <div>
                                <input type="search" class="form-control form-control-sm" id="table-search"
                                       placeholder="Search records..." style="width: 200px;">
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0" id="table-data">
                                    <thead class="table-light">
                                        <tr id="table-columns">
                                            <th colspan="100" class="text-center text-muted">
                                                <i class="fas fa-arrow-left me-2"></i>Select a table to view data
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="table-rows"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small" id="table-record-count">0 records</span>
                                </div>
                                <nav id="table-pagination"></nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SQL Query Panel -->
        <div class="tab-pane fade" id="query-panel">
            <div class="card">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">SQL Query (SELECT only)</label>
                        <textarea class="form-control font-monospace" id="sql-query" rows="8"
                                  placeholder="SELECT * FROM table_name WHERE condition..."></textarea>
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Only SELECT queries are allowed for security reasons
                        </small>
                    </div>
                    <button class="btn btn-primary" onclick="executeSQLQuery()">
                        <i class="fas fa-play me-2"></i>Execute Query
                    </button>
                    <button class="btn btn-secondary" onclick="clearSQLQuery()">
                        <i class="fas fa-eraser me-2"></i>Clear
                    </button>
                </div>
            </div>

            <!-- Query Results -->
            <div class="card mt-3" id="query-results-card" style="display: none;">
                <div class="card-header bg-light">
                    <h6 class="mb-0">Query Results</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" id="query-results-table">
                            <thead class="table-light" id="query-results-columns"></thead>
                            <tbody id="query-results-rows"></tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <span class="text-muted small" id="query-row-count">0 rows returned</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Database Settings Modal -->
<div class="modal fade" id="databaseSettingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-cog me-2"></i>Database Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Database Type Selection -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Database Type</label>
                    <select class="form-select" id="database-type">
                        <option value="sqlite">SQLite (Default)</option>
                        <option value="mysql">MySQL</option>
                    </select>
                </div>

                <!-- MySQL Configuration (Hidden by default) -->
                <div id="mysql-config" style="display: none;">
                    <h6 class="mb-3">MySQL Connection Settings</h6>

                    <div class="mb-3">
                        <label class="form-label">Host</label>
                        <input type="text" class="form-control" id="mysql-host" value="localhost">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Port</label>
                        <input type="number" class="form-control" id="mysql-port" value="3306">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Database Name</label>
                        <input type="text" class="form-control" id="mysql-database" placeholder="my_database">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="mysql-user" placeholder="root">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="mysql-password" placeholder="••••••••">
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> After changing to MySQL, you'll need to restart the server and run migrations.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveDatabaseSettings()">
                    <i class="fas fa-save me-2"></i>Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Record Modal -->
<div class="modal fade" id="editRecordModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Record</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="edit-record-form"></form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger me-auto" onclick="deleteCurrentRecord()">
                    <i class="fas fa-trash me-2"></i>Delete
                </button>
                <button type="button" class="btn btn-primary" onclick="saveRecordChanges()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Database Management JavaScript
let currentTable = null;
let currentRecordId = null;
let currentPage = 1;
let databaseSettings = {};

// Load database settings on tab load
function loadDatabaseSettings() {
    fetch('/api/accounts/admin/database/settings/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                databaseSettings = data.settings;
                updateDatabaseUI();
            }
        })
        .catch(error => console.error('Error loading database settings:', error));
}

// Update UI with database info
function updateDatabaseUI() {
    const badge = document.getElementById('db-type-badge');
    const status = document.getElementById('db-connection-status');

    if (databaseSettings.database_type === 'mysql') {
        badge.textContent = 'MySQL';
        badge.className = 'badge bg-info me-2';
    } else {
        badge.textContent = 'SQLite';
        badge.className = 'badge bg-success me-2';
    }

    status.textContent = databaseSettings.connection_status || 'Unknown';
}

// Show database settings modal
function showDatabaseSettings() {
    document.getElementById('database-type').value = databaseSettings.database_type || 'sqlite';

    if (databaseSettings.mysql_enabled) {
        document.getElementById('mysql-host').value = databaseSettings.mysql_host || 'localhost';
        document.getElementById('mysql-port').value = databaseSettings.mysql_port || 3306;
        document.getElementById('mysql-database').value = databaseSettings.mysql_database || '';
        document.getElementById('mysql-user').value = databaseSettings.mysql_user || '';
        document.getElementById('mysql-password').value = '';
    }

    toggleMySQLConfig();
    new bootstrap.Modal(document.getElementById('databaseSettingsModal')).show();
}

// Toggle MySQL configuration visibility
function toggleMySQLConfig() {
    const dbType = document.getElementById('database-type').value;
    const mysqlConfig = document.getElementById('mysql-config');
    mysqlConfig.style.display = dbType === 'mysql' ? 'block' : 'none';
}

document.getElementById('database-type').addEventListener('change', toggleMySQLConfig);

// Save database settings
function saveDatabaseSettings() {
    const settings = {
        database_type: document.getElementById('database-type').value,
        mysql_enabled: document.getElementById('database-type').value === 'mysql',
        mysql_host: document.getElementById('mysql-host').value,
        mysql_port: parseInt(document.getElementById('mysql-port').value),
        mysql_database: document.getElementById('mysql-database').value,
        mysql_user: document.getElementById('mysql-user').value,
        mysql_password: document.getElementById('mysql-password').value
    };

    fetch('/api/accounts/admin/database/settings/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Database settings saved successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('databaseSettingsModal')).hide();
            loadDatabaseSettings();
        } else {
            showAlert('Error: ' + (data.error || 'Failed to save settings'), 'danger');
        }
    })
    .catch(error => {
        showAlert('Error saving settings: ' + error.message, 'danger');
    });
}

// Test database connection
function testDatabaseConnection() {
    fetch('/api/accounts/admin/database/test-connection/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            loadDatabaseSettings();
        } else {
            showAlert('Connection failed: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error testing connection: ' + error.message, 'danger');
    });
}

// Load database tables
function loadDatabaseTables() {
    fetch('/api/accounts/admin/database/tables/')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTablesList(data.tables);
            }
        })
        .catch(error => console.error('Error loading tables:', error));
}

// Display tables list
function displayTablesList(tables) {
    const listGroup = document.getElementById('tables-list');
    listGroup.innerHTML = '';

    if (tables.length === 0) {
        listGroup.innerHTML = '<div class="text-center py-3 text-muted">No tables found</div>';
        return;
    }

    tables.forEach(table => {
        const item = document.createElement('a');
        item.href = '#';
        item.className = 'list-group-item list-group-item-action';
        item.innerHTML = `<i class="fas fa-table me-2"></i>${table}`;
        item.onclick = (e) => {
            e.preventDefault();
            loadTableData(table);
        };
        listGroup.appendChild(item);
    });
}

// Load table data
function loadTableData(tableName, page = 1, search = '') {
    currentTable = tableName;
    currentPage = page;

    const url = `/api/accounts/admin/database/tables/${tableName}/?page=${page}&search=${encodeURIComponent(search)}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTableData(data);
                document.getElementById('current-table-name').textContent = tableName;

                // Update active table in list
                document.querySelectorAll('#tables-list .list-group-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent.includes(tableName)) {
                        item.classList.add('active');
                    }
                });
            }
        })
        .catch(error => console.error('Error loading table data:', error));
}

// Display table data
function displayTableData(data) {
    const columnsRow = document.getElementById('table-columns');
    const rowsBody = document.getElementById('table-rows');
    const recordCount = document.getElementById('table-record-count');

    // Display columns
    columnsRow.innerHTML = data.columns.map(col => `<th>${col}</th>`).join('') + '<th>Actions</th>';

    // Display rows
    rowsBody.innerHTML = '';
    data.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = data.columns.map(col => {
            let value = row[col];
            if (value === null) value = '<span class="text-muted">NULL</span>';
            else if (typeof value === 'string' && value.length > 50) {
                value = value.substring(0, 50) + '...';
            }
            return `<td>${value}</td>`;
        }).join('') + `<td>
            <button class="btn btn-sm btn-primary" onclick='editRecord(${JSON.stringify(row)})'>
                <i class="fas fa-edit"></i>
            </button>
        </td>`;
        rowsBody.appendChild(tr);
    });

    // Update record count
    recordCount.textContent = `${data.total} records (Page ${data.page} of ${data.total_pages})`;

    // Update pagination
    updatePagination(data.page, data.total_pages);
}

// Update pagination
function updatePagination(currentPage, totalPages) {
    const pagination = document.getElementById('table-pagination');

    if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
    }

    let html = '<ul class="pagination pagination-sm mb-0">';

    // Previous button
    html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTableData('${currentTable}', ${currentPage - 1}); return false;">Previous</a>
    </li>`;

    // Page numbers (show max 5 pages)
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, startPage + 4);

    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="loadTableData('${currentTable}', ${i}); return false;">${i}</a>
        </li>`;
    }

    // Next button
    html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="loadTableData('${currentTable}', ${currentPage + 1}); return false;">Next</a>
    </li>`;

    html += '</ul>';
    pagination.innerHTML = html;
}

// Search table
document.getElementById('table-search').addEventListener('keyup', function(e) {
    if (currentTable) {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
            loadTableData(currentTable, 1, this.value);
        }, 500);
    }
});

// Edit record
function editRecord(record) {
    currentRecordId = record.id;
    const form = document.getElementById('edit-record-form');
    form.innerHTML = '';

    Object.keys(record).forEach(key => {
        if (key === 'id') return; // Skip ID field

        const div = document.createElement('div');
        div.className = 'mb-3';
        div.innerHTML = `
            <label class="form-label">${key}</label>
            <input type="text" class="form-control" name="${key}" value="${record[key] || ''}"
                   data-original="${record[key] || ''}">
        `;
        form.appendChild(div);
    });

    new bootstrap.Modal(document.getElementById('editRecordModal')).show();
}

// Save record changes
function saveRecordChanges() {
    const form = document.getElementById('edit-record-form');
    const updates = {};

    form.querySelectorAll('input').forEach(input => {
        if (input.value !== input.getAttribute('data-original')) {
            updates[input.name] = input.value;
        }
    });

    if (Object.keys(updates).length === 0) {
        showAlert('No changes detected', 'info');
        return;
    }

    fetch(`/api/accounts/admin/database/tables/${currentTable}/update/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            id: currentRecordId,
            updates: updates
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Record updated successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editRecordModal')).hide();
            loadTableData(currentTable, currentPage);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error updating record: ' + error.message, 'danger');
    });
}

// Delete current record
function deleteCurrentRecord() {
    if (!confirm('Are you sure you want to delete this record? This action cannot be undone.')) {
        return;
    }

    fetch(`/api/accounts/admin/database/tables/${currentTable}/${currentRecordId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Record deleted successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editRecordModal')).hide();
            loadTableData(currentTable, currentPage);
        } else {
            showAlert('Error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error deleting record: ' + error.message, 'danger');
    });
}

// Execute SQL query
function executeSQLQuery() {
    const query = document.getElementById('sql-query').value.trim();

    if (!query) {
        showAlert('Please enter a SQL query', 'warning');
        return;
    }

    fetch('/api/accounts/admin/database/execute-query/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayQueryResults(data);
            showAlert(`Query executed successfully! ${data.row_count} rows returned.`, 'success');
        } else {
            showAlert('Query error: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error executing query: ' + error.message, 'danger');
    });
}

// Display query results
function displayQueryResults(data) {
    const resultsCard = document.getElementById('query-results-card');
    const columnsHead = document.getElementById('query-results-columns');
    const rowsBody = document.getElementById('query-results-rows');
    const rowCount = document.getElementById('query-row-count');

    resultsCard.style.display = 'block';

    // Display columns
    columnsHead.innerHTML = '<tr>' + data.columns.map(col => `<th>${col}</th>`).join('') + '</tr>';

    // Display rows
    rowsBody.innerHTML = '';
    data.data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = data.columns.map(col => `<td>${row[col] !== null ? row[col] : '<span class="text-muted">NULL</span>'}</td>`).join('');
        rowsBody.appendChild(tr);
    });

    rowCount.textContent = `${data.row_count} rows returned`;
}

// Clear SQL query
function clearSQLQuery() {
    document.getElementById('sql-query').value = '';
    document.getElementById('query-results-card').style.display = 'none';
}

// Refresh database info
function refreshDatabaseInfo() {
    loadDatabaseSettings();
    loadDatabaseTables();
    if (currentTable) {
        loadTableData(currentTable, currentPage);
    }
    showAlert('Database info refreshed', 'info');
}

// Initialize when database tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const dbTab = document.querySelector('[href="#database-tab"]');
    if (dbTab) {
        dbTab.addEventListener('click', function() {
            loadDatabaseSettings();
            loadDatabaseTables();
        });
    }
});
</script>

<style>
/* Database Manager Styles */
#database-tab .card {
    border: 1px solid var(--border-color);
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

#database-tab .list-group-item {
    border-left: 3px solid transparent;
    transition: all 0.2s;
}

#database-tab .list-group-item:hover {
    background-color: var(--bg-hover);
    border-left-color: var(--primary);
}

#database-tab .list-group-item.active {
    background-color: var(--primary-light);
    border-left-color: var(--primary);
    color: var(--primary);
}

#database-tab .table-responsive {
    max-height: 500px;
    overflow-y: auto;
}

#database-tab .table th {
    position: sticky;
    top: 0;
    background-color: var(--bg-secondary);
    z-index: 10;
}

#database-tab .font-monospace {
    font-family: 'Courier New', Courier, monospace;
    font-size: 14px;
}

#database-tab .badge {
    font-size: 12px;
    padding: 4px 8px;
}
</style>
